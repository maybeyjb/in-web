# 维权

维权主要为蓝队研究，红队没有特殊需求不会深入
维权就是已经有了权限，需要维持。所以这里大多数就是在DC机器上进行操作。

[奇安信攻防社区-权限维持小结 (butian.net)](https://forum.butian.net/share/524)

坏了，这里有小问题，保存问题把这节的笔记丢了，最后自己重新写了一份。

#### ssp:

主要就是获取域内账号密码，使用的是mimikate启动后只要有域内用户登录就可以获得账号密码保存在log 文件中。但是这里需要写一个脚本exe/py来执行传输，将log文件以其他方式web/wims形式一直发送出来，这样就算是对目标机的权限丢了也可以实现获取到账号。

![1734328427144](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942382.png)

使用mimikatz将伪造的SSP注入内存：

![1734328869205](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942383.png)

密码存储在日志文件 C:\Windows\System32\mimilsa.log，此时是没有用户登录信息的：

![1734329065728](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942384.png)

然后在重新登录一下DC，就能抓捕到用户的账户密码信息：

![1734329121433](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942385.png)

![1734329132414](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942386.png)

## ssp脚本：

 因为上面的ssp一重新DC就会丢失权限，那么就需要将生成的存放账户密码的log文件弄一个定时任务，每10s对log获取一次，  一直对外传输获取，    编写上面传输脚本编写，得先看环境支持什么流量出去，这里看目标机上有什么服务支持，支持网站就用web传输出来。

DC作为发送方，web作为接受方：发送方每隔10s读取文件，将log文件发送到web，web接收数据，对数据进行本地存储。

问gpt ------------------小翻车，问不出来gpt，由于此环境只支持asp的，所以需要写asp脚本。但是这儿环境有点问题，解析不了asp。 --------  弄一个php环境，先演示一下效果，------  成功写出脚本，将py保存成exe执行就行---py转exe --   用pyinstaller.py进行py转exe。

![1734325068381](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942387.png)

本地写py文件脚本，持续访问目标，并且将收到的log文件实时更新log文件。然后将py转成exe上传DC机上运行后得到。然后得到登录Log记录。

主要就是能一直获取到自己生成的ssp用户账号密码

#### DSRM：

类似于一种快照技术、DSRM （ Directory Services Restore Mode,目录服务恢复模式）是Windows域环境中域控制器的安全模式启动选项。每个域控制器都有一个本地管理员账户（也就是DSRM账户）

一般是在这里，安装时候定义的dsrm：

![1734354554301](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942388.png)

DC打开输入命令：

![1734354576613](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942389.png)

这里的krbtgt用户是DC自带的，一般不会删除，比较稳定，krbtgt账户其实就是KDC秘钥分发中心用的超管账户

![1734354583482](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942390.png)



这里一般都是用krbtgt用户:

![1734354597128](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942391.png)



使DSRM的密码和指定域用户webadmin的密码同步

![1734354606530](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942392.png)

获取密码同步用户的hash值：

![1734354615636](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942393.png)

这里注意：在web普通域内用户时，要先用管理员打开mimikate,然后执行命令获取权限：

![1734354627961](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942394.png)

然后在web中，用mimikate执行命令创建一个新窗口可以和DC进行通讯，这里有问题，我猜是1、没有用那个krbtgt用户  2、或者就是我们机器没有设置dsrm

![1734354642542](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942395.png)

![1734354562769](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942396.png)



#### SID history：

看用户的sidhistory属性为空，可以利用。在Kerberos认证中，当客户端通过AS认证后，AS会给客户端一个TGT，kbrtgt的NTLM hash的又是固定的 因此可以得到krbtgt用户的NTLM hash，就可以伪造TGT进行下一步客户端与TGS的交互

获取某用户SID属性

![1734354032817](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942397.png)

这里是连接不到DC:

![1734354070538](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942398.png)

用mimikate给予某用户administrator属性：

![1734354092044](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942399.png)

获取历史后此时dbadmin的sidhistory：

![1734354136047](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942400.png)

然后也能连接上DC了，这里注意是用ip连接：

![1734354202059](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942401.png)

使用计算机名连接不允许，可能是因为域内解析是根据ip，无法解析到计算机名

![1734354250827](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942402.png)



#### Skeleton Key：

DC注入lsass进程、将Skeleton Key注入域控中的Isass.exe进程

先和域内尝试使用ipc通讯，这里需要使用正确密码才能连接到域内：

![1734354360451](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942403.png)

在DC机使用mimikate直接用一个命令创建万能密码：

![1734354411191](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942404.png)

下来就是用创建的万能密码连接，这里只要DC不删除这个万能凭证就能一直使用：

![1734354486695](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942405.png)



# 票据

面试爱问，维权、一般都是问这3个差异和应用场景。都是kerberos票据上的。环境为“rookit.org

注意注意：做实验时拍快照

删除连接----dir 

![1734421697448](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942406.png)

##### 黄金：

利用条件:

黄金票据的使用的必要条件是获取域中krbtgt用户使用的加密密钥

 先获取密钥---ntml aes256_hmac   aes128_hmac       还有sid值，目标域的sid值就是获取的sid值前面的

密钥

![1734411613587](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942407.png)

sid值：目标域的sid就为前面的sid。后面的为用户对应的编号

![1734411787822](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942408.png)

域名为god.org        DC的计算机名为 owa2010cn-god

![1734411877476](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942409.png)

 用web机访问DC拒绝访问：

![1734426886117](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942410.png)

收集信息结束，sid、域名、还有ntml aes256_hmac   aes128_hmac的三个中的一种

植入黄金票据：植入后就可以连接DC。这里的sid值为刚才获取的sid前面的,没有后面的编号，domain为域名，rc4为刚才的hash_html，id500为administrator组

![1734427158654](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942411.png)

成功后就可以dir访问到DC。



##### 白银：

银票仅允许攻击者伪造特定服务的票证授予服务 （TGS） 票据。和黄金票据的差异就是白银需要指定服务。service:cifs     黄金比白银更稳定，更持久，但是更容易被发现。白银就是更安全

  利用条件 ：白银票据所需的利用条件和黄金票据是相同的，只是秘钥换成了对应服务的机器账户 Hash(尾部带$的均为机器账户)也就是执行mimikate的机器。

首先获得被控机的hash值，带$的：

![1734427991176](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942412.png)

user：1111随便写

![1734429193471](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942413.png)

植入后就可以Dir访问

##### 蓝宝石：

 需要域内用户的账号密码、krbtgt aesKey、krbtgt nthash、

 这里需要一个魔改的脚本（原impacks里的）本地演示需要先改host，用py脚本执行后会生成一个票据，然后通过mimikate在域内执行票据然后通讯DC

还是先获取一些基本信息：

![1734430163759](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942414.png)

修改hosts:

![1734430576247](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942415.png)

生成蓝宝石票据：

域名、被控机账户密码、获取的lsadump::dcsync /domain:rootkit.org /user:krbtgt里面对应信息、生成的xiaodi票据

![1734430939694](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942416.png)

将生成 的xiaodi票据放到被控机的mimikate目录下，执行后就可以和DC通讯：

![1734431203660](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942417.png)



##### 钻石：

  krbtgt的hash、域内普通用户的账号密码、域内DC的计算机名、域名

   

得到基本信息后：

将脚本上传目标

![1734432327942](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942419.png)

执行命令会得到加密的数据：

![1734432233912](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942420.png)

将所以整理到一行执行:

![1734432294938](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942421.png)

执行后就可以dir  DC了

而且重启后还可以生效





### 差异：

黄金票据：能控制所有服务协议资源，但容易被安全设备捕获（伪造票据）

白银票据：只能控制指定服务协议资源，但不容易被安全设备捕获（伪造票据）

钻石票据：利用条件增多，权限维持更持续，更不容易被安全设备捕获（真实票据）

蓝宝石票据：利用条件增多，权限维持更持续，更难被安全设备捕获（真实票据——

黄金和白银重启后还可能会失效，但是钻石不会

https://mp.weixin.qq.com/s/rt2IpxGV-nhAp-3Cqpo1eA

[探究域渗透下的四种票据 - 先知社区 (aliyun.com)](https://xz.aliyun.com/t/13592?time__1311=GqmxuDc7iQeCqGNDQ0puDA2DjhDRxr%2BxLbD)

![image-20250415152847828](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942422.png)

![image-20250415152939436](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942423.png)

#自启动维权

到时间自动开始启动某项任务、基于服务器重启控制或时间（事件）触发后门执行保持权限维持

前3个是基于重启的：

#### 重启

##### 1：

   启动路径：C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup   也就是说在启动路径中的文件会自动执行。这里的Administrator改成当前计算机对应的用户名

![1734446640371](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942424.png)

将后门放进此目录下：

![1734446742300](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942425.png)

重启后自动加载：

![1734446840389](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942426.png)

##### 2：

  自启动服务加载。让exe改为自启动模式

就是这儿的服务有的是自动启动类型，这里让自己的后门也为自动类型：

![1734446940304](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942427.png)

创建xdsese服务：

![1734447192958](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942428.png)

重启后生效，并且服务处也是显示xdseseTest服务：

![1734447272212](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942429.png)

##### 3：

 自启动注册表加载   这个比较容易受到AV监测

![1734447681250](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942430.png)

打开注册表：

![1734448103854](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942431.png)

找到对应目录下：

![1734447812773](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942432.png)

执行启动命令：

![1734448020675](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942433.png)

重启后上线

这里的命令就是注册表前面文件的缩写---HKLM        HKCU：

![1734448133492](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942434.png)



#### 时间：

  计划计时任务

创建一个每天/每周定时执行的任务，这是基于时间的。schtasks命令

![1734448352647](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942435.png)



#### 事件：

###### 1

 组策略       基于事件的任务。也就是说，系统某个事件一执行时，对应就会启动任务。

添加登录事件：

![1734448654232](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942436.png)

这里写一个bat脚本更适合用来启动后门程序

![1734448884297](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942437.png)

![1734448872024](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942438.png)

重新登录后上线



###### 2

  粘滞键后门，shift 后门。连着按5下shift：会执行sethc.exe打开下面：

利用条件：开放的远程终端连接服务（3389）

![1734439543603](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942439.png)



![1734449125345](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942440.png)

此程序在windows高版本里没有对他操作的权限：

![1734449264976](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942441.png)

所以这里就对其进行解除权限的命令，在进行赋予权限：

![1734449449157](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942442.png)

这里可以copy cmd.exe sethc.exe将此sethc.exe替换掉cmd.exe，然后在执行mstsc时候输入密码错误会进入登录页面：

![1734489271212](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942443.png)

密码输入错误，点击是：

![1734489281786](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942444.png)

来到此页面，然后点击5下shift，触发刚才的sethc.exe，就会调用替换的cmd：

![1734489391600](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942445.png)

下来就是利用cmd来控制

#### 文件：

  文件映像劫持：

让cmd运行一些命令时会自动打开指定的后门，比如打开noptpad自动调用后门，或者执行python自动触发后门

![1734489698349](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942446.png)

在这里修改：

![1734489916640](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942447.png)

修改命令，产生：

![1734490503746](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942448.png)

更改后的命令：

REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe" /v debugger /t REG_SZ /d "C:\Windows\System32\cmd.exe /c C:\Users\Administrator\Desktop\test\11.exe"          是先调用cmd.exe然后/c执行后门文件

此时在执行notepad:

![1734490706925](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942449.png)

这里执行notepad后没有打开记事本并且停在这不动，所以容易被发现。

所以就配合GlobalFlag隐藏：执行正常关闭后触发，让他执行后发现不了：

![1734490929102](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942450.png)

将上面的3个命令执行完：

![1734491375702](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942451.png)

在打开notepad，就不容易被发现了，这里notepad也可以通过history找历史命令，看哪些常用替换，也可以是环境变量：

![1734491338647](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942452.png)



#### 无文件落地：

WinLogon文件夹

WinLogon配合无文件落地上线:

 userinit---用户初始化的文件，用户注册登录时候会调用userinit.exe，这时候就可以让他多调用有一个

![1734491710071](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942453.png)

添加：

![1734491799389](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942454.png)

然后只要有登录操作就会执行后门，上线

![1734491958717](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942455.png)

#### 屏幕保护：

  .scr时电脑屏保文件。就是一分钟没有动，就是自动调用.scr文件让电脑屏保，这里就是把.scr文件换成自己的后门,这里需要先打开屏保才能有scr文件

![1734493492576](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942456.png)

执行操作后等待屏保启动：

![1734493614682](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942457.png)

成功上线：

![1734493680814](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942458.png)

Logon Scripts登录脚本后门：

可以解决AV。因为他的进程是优先于杀毒进程启动，系统启动时会有调用进程的先后过程，但是后面AV可能会扫，能发现。

 就是初始化加载进程的利用。 

![1734494037426](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942459.png)

注销登录后成功上线

  还可以采用无文件利用。---就是说命令那里不一定就是后门文件路径，还可以是一个上线的远程下载命令或者其他上线命令

![1734494276061](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942460.png)

cs的powershell命令上线。--------- web投递

这里执行web投递命令powershell命令可能会因为单双引号的问题导致出错，因为Web投递的命令中有需要双引的命令：

![1734494613427](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942461.png)

直接问gpt

![1734494722233](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942462.png)

得到新命令后执行：

![1734494752070](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942463.png)

之后重新注销登录，上线：

![1734494796213](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942464.png)

# 	Rookit

有的大厂或者部门有一些硬件后门，放到硬件中来操控上线。

rx层次的区分，前面免杀了解过，就比如AV在r1层，你就把自己的后门放到r0层，或者比AV高的层次中就能够实现免杀。优先级的区别。rookit级别高，所以很难查杀。

找了CS的平替产品--------流量特征少--------找一些商业产品，既不是专门用来攻击的工具，又能用来满足我们攻击的需求。就像CS,MSF,此类产品，他就被定性为攻击工具。所以我们就需要找符合的产品，让他本来不是用来攻击的，但可以被我们用来测试。利用这些好的软件被我们用来做坏事。

gotohttp -------- 需要目标机有网（http/s）一种远控服务exe

  一运行就会产生ini配置文件，里面有电脑ID和控制码，用在线平台连接目标。

#### CS平替

![1734513829258](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942465.png)

打开配置文件里面的host，然后输入ID和控制码就可以连接：

![1734514075363](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942466.png)

缺点就是需要目标机出网，所以适用于跳板机。

  rustdesk 不需要网络也可以连接   todesk的衍生版本

  通过id连接需要网络，通过ip连接就不需要网络 。走的是软件专门的流量。

![1734514210027](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942467.png)

ip连接，但这里不是我们想的，实战中又不可能在这种UI页面操作进行配置：

![1734514278898](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942468.png)

所以有配置文件，可以通过配置文件（密钥rustdesk2就创建一个）来打开ip连接；

![1734514566762](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942469.png)

连接需要密码，在这里更改：

![1734515024212](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942470.png)

然后在用ip进行连接

![1734514991184](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942471.png)

#### r77-rookit

rookit后门：

  ----  蓝队排查：找近期文件去定性（微步），通过网络连接找到进程文件。

  process-hacker 工具，蓝队用来检查程序对外通讯情况，查找到后门exe。这里先cs上线：

![1734515562286](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942472.png)

然后直接就找到后门，仍VT或者微步上就识别出来。下来就看怎么防止被找到发现。

​    rookit后门就可以隐藏网络，隐藏文件，隐藏进程。

![1734515962553](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942473.png)

当上传后门后，就会产生通讯流量或者进程，rookit工具可以将你的后门产生的进程隐藏。(流量可隐藏不了，最多是加密流量，来迷惑一下)这里hide后门后， process-hacker和自带的任务管理器查看进程都没有后门的进程。做到隐藏进程。

![1734515926385](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942474.png)

网络连接：

通过隐藏网络连接，隐藏端口，这里是反向连接，连接的是远程8123端口：

![1734516284364](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942475.png)

add后网络中没有后门8123.exe的通讯了：

![1734516408702](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942476.png)

---1h02    

隐藏文件：让你的后门文件被发现不了，查看文件所在位置时找不到。这里就是利用rookit级别高于当前操作系统，所以你无法查杀。

![1734516516970](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942477.png)

这里应对方法就是让他找不到文件所在位置，只需在文件前加上$77的前缀，然后打开运行r77-rookit：

![1734516976269](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942478.png)

一运行那几个命名的文件都不见，尝试重命名后门文件后，也不见了：

![1734517049788](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942479.png)

这时候在打开文件所在位置就没反应了：

![1734517129800](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942480.png)

在hack工具中打开8123.exe也不行：

![1734517260303](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942481.png)

实战中就自己编译rookit，把其图形化的功能放到可执行的功能，生成命令行终端来操作。比如就是-y 就是用来隐藏进程，-u 就是隐藏网络，这类功能。

 蓝队怎么找rookit对应的，应该知道rookit家族的。另一款rookit工具：nidhogg----功能更多，玩法也复杂。https://mp.weixin.qq.com/s/elJ8t0TdInARm6GFtXTgTA

#linux维权



围绕linux特有的ssh协议------openssh。

登录方式，登录软件，登录机制，这里搞了个Centos系统

##### 登录软件openssh：

   openssh软件来支持ssh协议，在上面设置万能密码，然后重新安装。前面一种配置文件。 将万能密码插入进去

ssh配置如下，也就是说我们用xshell连接到centos系统的主要工具支撑就是用这个Openssh_7.4p1软件：

![1734533656938](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942482.png)

下来的操作就是将这个openssh替换了，自己下载一个和这相同的，然后替换里面的一个密码，修改成自己的万能密码连接。开始操作：

因为是环境配置，就跟着一步一步走，将两个openssh软件压缩包放入根目录下，因为wegt 下载太慢了，实战时候还是找个远程下载命令：

![1734532806343](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942483.png)

这些命令就一步一步敲，weget就自己上传了：

![1734533006184](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942484.png)

插进去万能密码：

![1734533103739](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942485.png)

更改openssh，和centos和最开始的版本对应：

![1734533929984](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942486.png)

安装编译，然后将原有的openssh覆盖成我们重新编译后带后门的openssh，有万能密码xiaodisec的

![1734534093911](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942487.png)

 时    复现到重新启动ssh服务后在用kali尝试连接目标，密码为xiaodisec

![1734575159358](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942488.png)

后门还可以记录登录成功的账号密码在ilog中，然后可以用web或其他服务将这个ilog文件实时的传输出去。实现监控服务器登录登出的账号密码（发到外网）参考https://mp.weixin.qq.com/s/BNrJHUs9qxEVHNSFEghaRw      这里复现失败。

![1734575408729](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942489.png)



##### 登录机制 pam：

  pam认证模块。  这里重置了centos。一样的道理， 还是将pam版本覆盖成自己带后门的，添加万能密码，进行ssh连接。

![1734576142576](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942490.png)

上面就对着敲就是，wget下载还是不行，直接自己托上去：

![1734576291141](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942491.png)

修改对应文件---Linux-PAM-1.1.8/modules/pam_unix/pam_unix_auth.c：

![1734576531790](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942492.png)

本地修改后上传，或者vim在线修改：

![1734576725060](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942494.png)

进入目录进行编译安装：

![1734576888574](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942495.png)

下来对着敲：

![1734576968237](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942496.png)

![1734577136499](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942497.png)

ssh连接时失败可能时因为缓存，要将原来连接过的缓存文件删除。

![1734577250289](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942498.png)

成功连接：

![1734577230758](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942499.png)

  配合软链接

看他开没开这个服务，然后就可以用命令开一个端口，然后远程连接这个端口不需要密码

![1734578011179](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942500.png)

任意密码都可以：

![1734578037584](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942501.png)

重置环境后操作，yes就可以操作：

![1734580813318](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942502.png)

![1734580880497](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942503.png)



##### 登录方式：

逻辑：本身服务器是密码登录，攻击者加一个密钥对文件进行登录服务器

密码：

密钥对：

  在本地生成的公钥文件上传到目标上，然后给上传的文件一个权限，然后在本地就可以直接连接目标

![1734578329958](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942504.png)

![1734578278863](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942505.png)

然后开启这3个服务（直接自己加上）：

![1734579252335](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942506.png)

本地kali生成密钥

![1734578674285](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942507.png)

将生成的公钥复制到服务器authorized_keys里：

![1734578622655](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942508.png)

成功添加公钥：

![1734579473639](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942509.png)

在用kali连接就直接连接不需要密码，这里需要在kali刚才创建公钥的那个目录下进行连接。

这里连接就是比对密钥对，密钥对比对成功就连接，所以只要有这个密钥对文件，都可以连接成功

![1734579773468](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942510.png)

连接成功：

![1734581064836](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942511.png)

当然也可以将这几个密钥文件放别的linux机上，也能不需要密码就能连接。

 添加后门账户，将他的uid设为0（root权限）

linux上是uid来区别权限：

![1734579906208](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942512.png)

这里就是添加uid=0 的用户（这条命令用于创建一个新用户（test1），并设置了多项特定的用户属性。命令中的各个部分功能如下：
useradd: 是Linux系统中添加新用户的命令。
-p openssl passwd -1 -salt 'salt' 123456: 这一部分用于设置用户的密码。具体步骤为：
openssl passwd -1: 使用MD5散列算法（-1代表MD5）来加密密码。
-salt 'salt': 指定一个盐值（在此例中为'salt'），用于增加密码加密的复杂度和安全性。
123456: 要设置的实际明文密码。这个命令将对“123456”使用MD5算法和指定的盐值进行加密，并将加密后的结果作为用户的密码。
注意，命令中的反引号（`）用来执行括号内的命令并将其输出作为-p选项的参数。
test1: 新用户的用户名。
-o: 允许在某些与系统账户管理策略冲突的情况下仍然添加用户。例如，如果系统配置不允许有相同UID的用户，此选项可以强制添加。
-u 0: 设置新用户的用户ID（UID）为0。在Linux系统中，UID为0的用户是root用户，拥有最高权限。
-g root: 指定新用户的主用户组为root。这意味着用户test1将属于root组，能够访问该组的资源和权限。
-G root: 指定新用户除主用户组外还属于其他附加组，这里也是root组。这通常是为了赋予额外的权限，但由于已经设为主用户组为root，这里的效果等同于-g选项，但强调了多组归属。
-s /bin/bash: 设置新用户的默认shell为/bin/bash。这意味着当用户登录时，默认使用的交互式shell将是Bash。
-d /home/test1: 设置新用户的家目录为/home/test1。这是用户登录后默认的工作目录。
综上所述，整个命令的作用是创建一个名为test1的新用户，该用户具有root权限（因为UID为0且属于root组），其密码被设定为经过MD5加密并加盐处理的"123456"，默认shell为Bash，家目录位于/home/test1。）：

![1734580171528](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942513.png)

创建成功：

![1734580210553](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942514.png)

连接test用户，密码123456,成功连接，这里环境被玩崩了。。。。

![1734580295924](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942515.png)

重置一下：

![1734580669744](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942516.png)

  linux工具  -----   hackpermkeeper   

linux隐藏：也是用到了rookit。

# linux维权

这里是本地centos为目标机，服务器为自己的攻击机。下面许多直接在目标机上编辑文件的，实战中可以采用本地先写好，然后直接上传文件到目标机上就行。

#####  计划任务：

  编辑后门反弹、创建定时任务

编辑后门反弹并且添加定时任务：

![1734610837770](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942517.png)

![1734610811411](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942518.png)

每分钟执行一次/etc/.xiaodi.sh文件：

![1734610602318](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942519.png)

一分钟后成功得到反弹shell：

![1734610891422](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942520.png)

  strace后门：动态跟踪工具，它可以跟踪系统调用的执行：

用linux自带工具创建一个记录sshd明文，里面是存储的是谁登录过服务器的记录，查看此时里面没有内容：

#### ![1734611385859](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942521.png)

然后在登录一次服务器查看，有登录的密码等信息：

![1734611524400](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942522.png)

  ---------   (小翻车)        alias后门  ，利用python执行反弹命令。将反弹的命令和系统命令比如ls，绑定到一起，执行ls，时就会执行反弹命令。

ls -al 就是显示出隐藏的文件。这里alias的用处：就是执行ls等于执行ls -al：

![1734611615311](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942523.png)

![1734611735949](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942524.png)

这里就利用alias，来实现我们的维权目的。将反弹命令写到ls中：

![1734612515977](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942525.png)

成功接收到：

![1734612628422](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942526.png)

但是这里可以发现，在目标机上执行ls时他会一直停在那儿，显然这种不合适，所以下面用另一种命令，py脚本反弹命令：

![1734614103189](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942527.png)

执行：

![1734614979210](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942528.png)



##### rootkit

reptile       隐藏技术

 环境配置，上传后门文件。

![1734616279393](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942529.png)

![1734616548380](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942530.png)



###### 隐藏文件：

reptile

![1734616706581](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942531.png)

但是可以进入隐藏文件：

![1734616773122](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942532.png)

 ---- 翻车

###### 进程隐藏：

![1734617172542](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942533.png)





  msf----------  安装msf       

安装后msf：

![1734617866406](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942534.png)



  生成msf 后门，没有用rootkit技术，后门的外联ip、进程、文件位置都会暴露。

将刚才msf生成的后门shell.elf上传到目标机上，执行：

![1734618057586](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942535.png)

成功监听上线：

![1734618137409](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942536.png)

在目标机上还是很容易发现后门文件，进程的：

![1734618299853](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942537.png)

  隐藏文件：更改文件名，reptile开头。  ---  隐藏进程。隐藏tcp 连接

下来就是隐藏文件和进程即可：

修改文件名reptile开头、进程隐藏id-------这里要注意，reptile是开着，如果报错就重新安装一遍、unzip---chmod +x setup.sh---------./setup.sh  ------- ./setup.sh  install (注意删除是./setup.sh remove 可别delet 删不干净) ：

这里已经找不到shell.elf（刚开始改完名字后后门文件没有隐藏，一直以为是rookit工具有问题，最后只需要将打开的这个test文件重新打开一下，改完名字的文件就消失了）

![1734620180515](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942538.png)

执行后后门查看进程：

![1734620495086](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942539.png)

netstat -anpt --  通讯连接
pa -ef   查看进程

![1734621042739](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942540.png)

隐藏：

![1734621230783](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942541.png)

隐藏后不影响通讯：

![1734621261917](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942542.png)

###### 高级玩法 

  rookite高级玩法             又重新弄

![1734621895593](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942543.png)

上面的被控机的reptile在安装时选了有服务端，然后添加了服务端的ip  端口6565，所以可以操作

![1734622735875](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942544.png)

这里就不演示了，反正配好后run就好了:，唯一需要注意就是客户端和服务端的区分：

![1734622904056](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942545.png)



 弱鸡的工具

自动化检测当前的脚本下有没有可以部署的维权后门：

![1734623026282](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942546.png)

主要是main.py文件：

![1734623291122](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942547.png)

