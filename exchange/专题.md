# exchange

是微软公司的一套电子邮件服务组件，是个消息与协作系统。

1：自身漏洞

2：钓鱼攻击

3：暴力破解

  信息收集  代理。这里是google浏览器证书问题，他会检测是否在内网浏览器，然后换火狐浏览器。ip+/owa。    环境说明：cs服务器和内网机在同一个网段。方便操作

![1733885385238](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942281.png)

通过端口扫描、SPN探测等手法发现Exchange服务：

![1733885497007](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942282.png)

结果：

![1733885625511](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942283.png)

SPN探测，先获取到域名（shell net time /domain），然后SPN技术探测开放了哪些服务：

![1733886017828](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942284.png)

这里发现DC机器开放了exchange服务，并且得到了DC机器名，然后ping DC机器名得到DC的ip地址：

![1733886115060](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942285.png)

这里exchange服务默认是https,所以访问时候需要加https，用火狐浏览器打开-----socks代理建立

![1733890517797](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942286.png)

owa:

![1733890561798](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942287.png)

这里密码就是抓，导，爆破获取明文密码。

#### 1：

这里开代理用bp暴力'''''破解。  bp的代理设置。

![1733890813326](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942288.png)

信息收集：脚本matchvul.py  （这里还是socks代理已经配置好）。或者查看源代码找到exchange版本号，然后在微软官方上查版本对应。

![1733891229058](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942289.png)

找到版本号查找对应产品版本

![1733891363327](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942290.png)

 演示一下怎么从普通用户拿到域内用户账号密码，提权----mimikate需要高权限抓取，抓取明文密码。 下来然后用网上的exp进行攻击。最后会写一个Webshell进去，然后就 连接上线

![1733894720750](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942291.png)

编译生成exe后运行，这里还是socks已建立----------报错：

![1733895126006](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942292.png)

更改hosts：

![1733895146445](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942293.png)

成功写入shell：

![1733895196960](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942294.png)

![1733895245525](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942295.png)

打开写入的文件，这里只需要将shell改为webshell就可连接：

![1733895326068](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942296.png)

#### 2：

  另一个漏洞脚本.需要更改域名的host地址，还需要生成一个反序列化的payload， 更换目标机：exchange2013版本机器sp1， socks代理配好后，用脚本Cve2020-0688进行连接，生成一个ysoserial.exe的命令，用命令在ysoserial.exe上执行生成一个反序列化的payload，将这个payload在脚本Cve2020-0688中运行后能执行Rce。条件：需要一个普通域内用户的账号密码

这里失败，因为是需要exchange-sp3版本，这里是sp2版本,换环境：rootkit域

环境没有搭建，这先凑合着看，这儿对py版本还有要求：

![1733896357925](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942297.png)

执行后会生成一个命令，这里是让他执行mstsc命令（远程桌面连接）：

![1733896958499](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942298.png)

将命令用ysoserial.exe运行生成反序列化字符串：

![1733897053617](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942299.png)

将生成的反序列化字符串重新复制到刚才的cve下的payload中执行：

 ![1733897252056](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942300.png)

然后目标DC机就会执行mstsc打开。

 没有用户凭证时：proxyshell工具，这里环境不适用，适合打新版本，需要的目标版本条件比较苛刻

python exchange_proxyshell.py -u https://192.168.3.142

![1733897498222](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942301.png)



  钓鱼 ：免杀后门附件、网站监听获取ntml hash---------发一个内网ip（被控机），然后诱惑点击

#  ![1733897952043](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942302.png)

发给DC进行钓鱼：

![1733897993239](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942303.png)

