# 让域内上线方法


环境说明：本机YJB能ping 通god/web 机，god/web里的都出不来。然后下面先通过YJB作为跳板上线

![1732977961289](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942153.png)

   遗留问题：切换用户上线 。上面web机不能切换用户上线是与系统版本有关，windows2008不支持

这里是sql的域外用户：

![1732978327097](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942154.png)

执行切换用户：

![1732978732634](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942155.png)


### wmi服务



方便管理员对windows主机进行管理，开启了此服务。所以可以用WMI进行横向移动，支持用户名明文或者hash的方式进行认证，并且该方法不会在目标日志系统留下痕迹。利用条件：

1、WMI服务开启，端口135，默认开启。

2、防火墙允许135、445等端口通信。

3、知道目标机的账户密码或HASH。一般都是先收集到目标主机浏览器密码，其他服务密码去套

使用内置wmic 缺点：无回显。需要有明文（不支持hash）优点就是wmic命令是内部命令（白名单）



​    用被控机ping 内网目标机---能通就建立正向后面在connect ---ping 不通就 反向后门（转发上线），这里关键的点还有web刚好有一个web服务，可以实现向目标sql机执行后门上传文件命令。(这里的web服务是前面信息大点收集的，查看端口开放，查看web机器有没有网络服务net start  ，有IIS Admin service 的服务，可以将上传的后门放到web目录下，然后就可以实现向sql机后续操作)

![1732980057421](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942156.png)

![1732980083249](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942157.png)

找到iis服务的默认web存储路径

![1733041150663](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942158.png)

上传zx后门到IIS的web服务路径下，后期和sql目标机建立连接后用来上传：

![1733041338449](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942159.png)

  套件工具  可以用hash加密，也支持交互式的密码连接。较推荐-----一般py文件可以打包成exe然后上传到目标机上运行，不过一般不选择这种方式，太明显（流量+免杀）。一般选择在本地机器上执行，这里是建立web机的administrator用户流量隧道/socks通道。

![1732980227409](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942160.png)

用socks代理在web机上建立节点。用工具执行命令与sql建立连接，成功与目标机通讯，然后可以上传后门先到被控机web上，在执行上传后门的命令实现上线。（这里思路清晰点：是通过web机建立的通讯，自然也是通过web机上传的后门到sql机上）
目前web机已经上线
#### 横向
通过impacket包里针对wmi协议的的wmiexec脚本工具对目标进行横向:

这里先是拿到sql的Shell、直接利用web机搭好socks代理，用wmi脚本实现shell：

![1732980610905](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942161.png)

通过拿到的shell上传文件-----真实下是因为YJB只能和web机通讯，web机作为内网机能与sql机通讯，所以需要通过web机来上传exe到sql机：
这里是通过wmi脚本，让其远程下载web机开放的后门，实现上线sql机。
![1733041773785](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942162.png)

执行3232.exe 用web 机connect             sql机：

![1733041956661](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942163.png)

####  c2插件  
  需要上传vbs。所以不建议

![1733042053179](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942164.png)

### SMB:



开启了打印和文件共享作用的服务

   CS不支持交互式。所以psexec工具（PsExec.exe为白名单程序）不建议-------------一般用图形化工具可以：

![1733042538285](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942165.png)

  还是用套件----工具  smbexec.py  和上面一样，配好节点后建立连接：

![1733042836602](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942166.png)

#### hash加密也可以横向

这里hash加密也可以，要对应好：

![1733044504518](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942167.png)

  cs插件  ---    cs-psexec， 对sqlsever进行上线操作

![1733044623385](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942169.png)

这里用户密码自己选择，监听器一般选择正向，如果能通的话，工具会自动连接。这里域一般选择能与目标通信，且在一个域内，会话选择能通信的。这里主要还是要确保用户，密码，域三个都得对应正确。

![1733045756767](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942170.png)

sqlserver成功上线

![1733045902645](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942171.png)

### DCOM


0.适用目标Win7系统以上-----因为这个是建立在powershell命令基础上

1.管理员权限PowerShell

2.远程主机防火墙未阻止

​     dcomexec-impacket   dcomexec.py   一样的，工具箱中的py文件执行命令----支持hash和明文		python dcomexec.py sqlserver/administrator:admin!@#45@192.168.3.32

​      wmi防火墙的，windows manage ni...那个入站还是出站的策略（xd没看见）试一下开一下防火墙能否通过wmi，wmi也不会在日志中被记录  

#### 防火墙

SMB ：

![1733048252797](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942172.png)

DDOM：

![1733048364506](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942173.png)

wmi也有，不过没找到。

##总结：
3种协议的横向，都与账密有关，有的需要明文，有的只需要hash值就可以实现横向。属于pth一种。
