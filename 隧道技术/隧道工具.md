# 隧道代理常见工具

FRP      NPS      Chisel         传输层

  配置frp

frp建立通道   可以实现跨内网通讯，两个内网的机可以互相通讯。需要配置.ini 文件，这里的serverAddr的地址为跳板机的地址，frps文件配置在跳板机上。frpc放在自己的攻击机上。[[proxies]]是名字可以更改任意，上面的两个配置是尝试连接远程服务地址。下面是尝试将（因为这里没有remoteip地址，所以remotePort就是上面服务端的端口）远程服务端6000 转到 本地客户端（127.0.0.0 这里的本地就是cs的上线服务端kali）的22端口  采用的是tcp协议，备注名字为[[proxies]]

<img width="487" height="393" alt="image" src="https://github.com/user-attachments/assets/362e3888-e5b4-4902-bcb2-234411abfaca" />


配置信息：将远程的6666端口转发到本地的5555端口。

<img width="992" height="657" alt="image" src="https://github.com/user-attachments/assets/e53f704a-2e19-4727-afda-f11c0754aa4c" />


成功建立连接：

![1732703083871](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942083.png)

然后在生成2个监听器，分别为1---远程服务端的和2---本地服务端（kali）地址的监听器。用1监听器生成一个后门。然后1后门执行就会访问远程服务端，因为frp会将这上线访问转发到本地服务端，那么2监听器就能获取到上线。1后门执行在一个内网机A中，A是可以访问到外网1远程服务端，而1又转发到内网机B上，那么就实现了AB内网机之间通信。借助了外网服务器作为跳板。frp充当隧道建立连接。

![1732635242104](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942084.png)

生成远程服务器的后门 --  6666.exe：

<img width="1244" height="665" alt="image" src="https://github.com/user-attachments/assets/02acab1a-7e50-4d4f-88fb-8a86a3062dc9" />


成功上线，并通过frp隧道转发到kali上，成功上线（frp1生成后门，frp2监听上线）---这里的真实环境是 web 机在一个北京内网中，kali的cs在一个武汉内网

<img width="1367" height="795" alt="image" src="https://github.com/user-attachments/assets/05b2c9c5-b8ff-43a7-ab2d-465e4bcc5f6e" />




可以将生成的后门丢微步在线里，会自动溯源到你的跳板机（外网机上），实际你是在内网的服务机（kali）上上线的。有一定的隐藏，防溯源。         frps    服务端         frpc  客户端             socks要看入站检测（通过节点进去），端口映射要看出站检测（让他把自己的端口映射出来）

####   frp 

信息收集：建立socks节点做信息收集             端口映射转发做信息收集

   frp建立socks节点。上面frp的客户端是kali主机，但是如果还在kali上建立socks节点，kali上没有2网段，还是访问不到目标的2网段内网口。所以节点需要在目标139的外网口上建立

在被控机web上执行frpc，将远程服务端的6000端口成为socks代理，接下来只要通讯服务器的代理就可以通讯到客户端（被控机）

<img width="1039" height="1019" alt="image" src="https://github.com/user-attachments/assets/3b1b69da-9fb4-488c-8850-33045533a132" />


配置frpsocks.ini文件，让服务器开一个web页面。7000端口是用来通讯的，7500是用来看web页面的

![1732709310211](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942088.png)

执行后，可以看到frp通讯的一些信息：

<img width="1367" height="635" alt="image" src="https://github.com/user-attachments/assets/e251e457-09af-4de1-b290-af98c9b92c50" />


成功建立socks节点，这里注意：这个socks的ini ，客户端的编写一定要注意书写规范（已踩坑）



这里配置代理前还是在本机（武汉内网）访问不到目标内网主机：

![1732711469615](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942091.png)

配置代理，成功访问：

<img width="1020" height="695" alt="image" src="https://github.com/user-attachments/assets/a42de69f-0270-4438-b13d-4577b3704bce" />



用到frp建立socks的场景就是：拿到目标的webshell后但是被出入站等原因阻止导致上线不了cs，而又要对目标主机进行信息打点（收集），那么这时就用不了cs来建立socks节点，所以就上传frp到被控机创建socks节点。                                                                                                                  条件：出站没限制。------  这里是相当于用被控机来访问内部网络，（看上面的图，为2.11的内网口）所以没限制就是指的是能访问内网口没限制，不是指出站都没限制。

  端口映射，这下相当于是以目标的139网段为跳板机来访问内网2网段。将内网段2的流量映射到外部服务器上。这两个方法差异还是出入的问题：

![1732714593709](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942093.png)

成功代理，访问服务器8888端口：---代理转发
<img width="1367" height="426" alt="image" src="https://github.com/user-attachments/assets/5de17902-32ed-413f-853a-0c0d1508ca84" />



####  nps     

配置nps：ini / conf  文件

![1732715155373](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942095.png)

打开页面：     nps服务端 

<img width="1367" height="594" alt="image" src="https://github.com/user-attachments/assets/409b8837-9abc-48b1-b312-4de4cc8b765e" />


 npc 客户端，新建客户端：
<img width="1367" height="457" alt="image" src="https://github.com/user-attachments/assets/530216b1-f04b-4dbd-beec-e9b0b57c9746" />



客户端执行命令：

<img width="1367" height="635" alt="image" src="https://github.com/user-attachments/assets/e0a7bcfb-1add-4bf8-987a-ffd2590254db" />


新增tcp隧道，将服务端6666端口转发到本地（谁执行的客户端命令---kali）5555端口：

![1732715763204](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942099.png)

![1732715776156](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942100.png)

生成后门，监听上线--通过tcp隧道转发：

<img width="1367" height="581" alt="image" src="https://github.com/user-attachments/assets/50530350-b517-4af9-99a4-804d66a18865" />


##### socks节点：

这里就不能用刚才的kali为客户端，因为kali通讯不到内网机（2.11网段），需要在被控机上建立客户端socks：

<img width="1367" height="684" alt="image" src="https://github.com/user-attachments/assets/11c643e5-8d36-47d0-a529-f01d3d554ea1" />


上面web隧道中选择socks代理：

![1732716085384](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942103.png)

插件或者Proxifier设置:

<img width="1367" height="232" alt="image" src="https://github.com/user-attachments/assets/7c08aa08-0c03-420f-a810-2e450d739ef6" />


   

##### 端口映射 

访问服务端8899相当于访问192.168.2.22:80

![1732716752088](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942105.png)

<img width="703" height="253" alt="image" src="https://github.com/user-attachments/assets/8ad32978-93cb-4f3b-ac95-dc13e99cd06c" />


#### chisel:

较前面的两款较为冷门-------流量特征好改

服务端打开：c2上线：

![1732717569073](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942107.png)

 还有一样1后门，2监听。web执行1（6666.exe）后2监听上线。命令：建立与8.*.*..*:1234的连接，将远程的6666端口的流量给到自己192.168.139.128:5555端口
<img width="1367" height="775" alt="image" src="https://github.com/user-attachments/assets/c2645769-9bc9-4249-a268-865b78a6447d" />

<img width="1317" height="142" alt="image" src="https://github.com/user-attachments/assets/4aa37730-fcf8-4644-80fd-dec794842def" />


socks节点：

![1732718527371](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942110.png)

代理转发：

<img width="1367" height="531" alt="image" src="https://github.com/user-attachments/assets/35060adc-6d7a-4ee1-8ef3-a6282f964b78" />


访问成功：

<img width="1314" height="247" alt="image" src="https://github.com/user-attachments/assets/e3b71149-5cd4-4881-a523-4e9f976ecfa9" />

##总结:
借助frp隧道代理，通过外网服务器为跳板实现2个内网之间主机进行通讯。
几款代理工具，各有特点，
端口映射就是访问123.234.123.123:88端口相当于访问12.12.12.2：80端口  映射过去了
