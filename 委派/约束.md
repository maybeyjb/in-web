# 委派
  委派也是横向里的一种方法，利用委派条件进行横向获取更多主机。
  
  DC设置环境  	机器/主机委派     设置webserver为非约束委派后，下来就只需要获取票据就可以直接和域控通讯，不需要别的认证。（非约束委派好像一个代理人，秘书一样，说的话就和自己说的话分量一样重）

![1733470670239](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942230.png)

还可以用命令设置用户有委派权限（这里的Webadmin用户一开始属性是没有委派这个选项的）：

![1733471273215](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942231.png)

没有复现，环境问题：

攻击条件：

1、需要Administrator权限

2、域内主机的机器账户开启非约束委派

3、域控管理员远程访问（主动或被动）

 测试。通过工具测试是否存在委派机器 。

将工具adfind.exe上传，有委派用户：

![1733476484278](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942232.png)

没委派用户：

![1733476514419](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942233.png)

有委派机器webserver ，DC（本身就有）：

![1733476560577](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942234.png)



DC方法：查到委派机器后钓鱼让DC访问委派机器，拿到票据（类似上节的历史漏洞）

#### 非约束委派：

 翻车---------      一种是让DC主动访问过委派机，或者就是制作一个钓鱼网页在委派机上等待DC连接这两种其实比较鸡肋。

![1733476653795](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942235.png)

得到票据：

![1733476668172](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942236.png)

导入内存并且连接DC:

![1733476711436](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942237.png)

下来是另一种方法：结合打印机漏洞（对DC操作系统有要求：win2012以上），让DC强制访问 自己

DC是win2012以下版本演示： 

让DC连接Webserver（当前被控机）

![1733476832224](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942238.png)

报错：

![1733476873820](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942239.png)

DC为win2012上（xiaodi8）：       web机的administrator先建立一个监听器，然后让DC强制连接web机,然后得到hash.txt。这里需要用生成监听的工具来导入，因为生成监听器时用的工具，所以这里的hash格式和mimikate的不符合。这里的导出的票据为DC的，解密还是用mimikate，这里可以获取到域内所有的hash

![1733558618295](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942240.png)

演示：  这里环境问题，正反向都不出网，就在本机上操作了，演示说明即可：DC：windows2016---								被控机	windows10 ----- xdpc  ,将被控机用户和机器都是非约束委派

![1733478554095](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942241.png)

Rubeus监听来自DC的请求数据并产生hash.txt保存hash：

![1733480322588](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942242.png)

域用户运行SpoolSample强制让DC请求：

![1733480367867](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942243.png)

Rubeus监听到请求并产生hash.txt:

![1733480401638](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942244.png)

Rubeus监听到票据并导入该票据(底下的hash):，上面解释了为什么这里用Rubeus导入不用mimikate：

导入成功  --------这里主要导入的hash值需要先放到一行后在导

![1733481072639](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942245.png)

这里的票据是DC的票据，用mimikate获取到所有的hash，

![1733559526609](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942246.png)

下来在继续  使用wmi借助hash横向移动

![1733559610884](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942247.png)



  打印机服务

![1733559669699](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942248.png)

win2012以下攻击：

#### 约束委派：

1h05  判断约束委派	

![1733560100843](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942249.png)    条件：

![1733559954414](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506170942250.png)   																																			

 获取webadmin票据（将票据理解成一种免死金牌）。用s4u方法利用刚才获取的webadmin票据请求DC，进而得到DC的票据。将DC的票据用mimikate导入票据到内存中，然后成功通讯DC(shell dir \\owa2010cn-god.god.org\c$)

[奇安信攻防社区-红队域渗透技术：委派攻击汇总（全） (butian.net)](https://forum.butian.net/share/1591)

1和靶场：上期135day
